<!DOCTYPE html>
<html lang="en">
<head>
  <script src="wordle-dictionary.js"></script>
  <meta charset="UTF-8" />
  <title>Squaredled Away – Kyra's Birthday Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Readable, cozy fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&family=Baloo+2:wght@500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      /* Night bathhouse palette */
      --sky-top: #020414;
      --sky-mid: #101633;
      --sky-bottom: #1c1530;

      --hill-dark: #101820;
      --hill-mid: #15222c;
      --hill-light: #1a2b33;

      --water-top: #111a2c;
      --water-mid: #172135;
      --water-bottom: #101524;

      --card-bg-soft: rgba(23, 16, 43, 0.96);
      --card-border: rgba(120, 91, 166, 0.9);
      --card-shadow: 0 22px 46px rgba(0, 0, 0, 0.95);

      --accent: #f2b26e;
      --accent-soft: rgba(240, 189, 120, 0.2);
      --accent-strong: #ffd49c;
      --accent-deep: #b95345;

      --text-main: #fdf7f0;
      --text-muted: #c2b7d2;

      --tile-bg: #261721;
      --tile-edge: #8b4b3f;
      --tile-selected-border: #f7e0a1;

      --danger: #f26f80;

      --radius-xl: 26px;
      --transition-fast: 140ms ease-out;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
  margin:0;
  padding:0;
  background:url("spiritedawaybackground.jpg") no-repeat center center fixed;
  background-size:cover;
  font-family:"Nunito",system-ui,sans-serif;
  color:#fdf6e8;
  min-height:100vh;
  overflow-x:hidden;
}

    @media (max-width: 900px) {
      body {
  margin:0;
  padding:0;
  background:url("spiritedawaybackground.jpg") no-repeat center center fixed;
  background-size:cover;
  font-family:"Nunito",system-ui,sans-serif;
  color:#fdf6e8;
  min-height:100vh;
  overflow-x:hidden;
}
    }

    /* POSTER: your wallpaper */
    .scene-poster {
      pointer-events: none;
      position: fixed;
      inset: 0;
      z-index: -7;
      background-image: url("spiritedawaybackground.jpg");
      background-position: center bottom;
      background-repeat: no-repeat;
      background-size: cover;
      filter: brightness(0.95) saturate(1.08);
      opacity: 0.85;
    }

    /* STAR FIELD */
    .scene-stars {
      pointer-events: none;
      position: fixed;
      inset: 0;
      z-index: -6;
      background-image:
        radial-gradient(circle, rgba(255, 255, 255, 0.7) 1px, transparent 0),
        radial-gradient(circle, rgba(255, 255, 255, 0.5) 1px, transparent 0),
        radial-gradient(circle, rgba(255, 255, 255, 0.6) 1.5px, transparent 0);
      background-size: 220px 260px, 260px 320px, 300px 280px;
      background-position: 10% 0%, 70% 15%, 40% 30%;
      opacity: 0.55;
    }

    /* CLOUDS */
    .scene-clouds {
      pointer-events: none;
      position: fixed;
      inset: 0;
      z-index: -5;
    }

    .cloud {
      position: absolute;
      width: 260px;
      height: 80px;
      border-radius: 40px;
      background: radial-gradient(circle at 20% 40%, rgba(255, 255, 255, 0.9) 0, rgba(228, 227, 255, 0.5) 40%, transparent 80%);
      filter: blur(2px);
      opacity: 0.45;
      animation: cloud-drift 60s linear infinite;
    }

    .cloud::before,
    .cloud::after {
      content: "";
      position: absolute;
      border-radius: inherit;
      background: inherit;
    }

    .cloud::before {
      width: 180px;
      height: 60px;
      left: -40px;
      top: 10px;
    }

    .cloud::after {
      width: 160px;
      height: 50px;
      right: -30px;
      top: 16px;
    }

    .cloud.c1 { top: 8%; left: -15%; animation-duration: 90s; }
    .cloud.c2 { top: 14%; left: 40%; animation-duration: 72s; }
    .cloud.c3 { top: 4%; left: 65%; animation-duration: 80s; opacity: 0.38; }

    @keyframes cloud-drift {
      from { transform: translateX(0); }
      to { transform: translateX(180%); }
    }

    /* HILLS / WATER / REFLECTION */
    .scene-horizon {
      position: fixed;
      left: -20%;
      right: -20%;
      bottom: 0;
      height: 55vh;
      pointer-events: none;
      z-index: -4;
    }

    .scene-hills {
      position: absolute;
      left: -10%;
      right: -10%;
      bottom: 18vh;
      height: 26vh;
      border-radius: 50% 50% 0 0;
      background:
        radial-gradient(circle at 15% 0%, rgba(117, 163, 171, 0.25) 0, transparent 55%),
        radial-gradient(circle at 75% 0%, rgba(198, 231, 238, 0.2) 0, transparent 55%),
        linear-gradient(180deg, var(--hill-light), var(--hill-mid));
      box-shadow: 0 -18px 40px rgba(0, 0, 0, 0.75);
    }

    .scene-hills::before {
      content: "";
      position: absolute;
      inset: 18px 10%;
      border-radius: 50% 50% 0 0;
      background:
        radial-gradient(circle at 30% 0%, rgba(91, 144, 152, 0.35) 0, transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(80, 116, 129, 0.35) 0, transparent 60%),
        linear-gradient(180deg, var(--hill-mid), var(--hill-dark));
      opacity: 0.9;
    }

    .scene-water {
      position: absolute;
      left: -10%;
      right: -10%;
      bottom: -10vh;
      height: 32vh;
      background:
        radial-gradient(circle at 20% 0%, rgba(108, 143, 192, 0.3) 0, transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(248, 210, 151, 0.25) 0, transparent 60%),
        linear-gradient(180deg, var(--water-top), var(--water-mid), var(--water-bottom));
      opacity: 0.9;
      box-shadow:
        0 -16px 30px rgba(0, 0, 0, 0.9),
        inset 0 16px 28px rgba(0, 0, 0, 0.65);
    }

    .scene-water::before {
      content: "";
      position: absolute;
      inset: 8% 6%;
      background-image:
        linear-gradient(
          rgba(255, 255, 255, 0.06) 1px,
          transparent 2px
        );
      background-size: 100% 10px;
      opacity: 0.4;
      mix-blend-mode: screen;
    }

    .scene-water::after {
      content: "";
      position: absolute;
      left: 18%;
      right: 18%;
      top: 8%;
      height: 36%;
      border-radius: 50% 50% 50% 50%;
      background: radial-gradient(circle at 50% 0%, rgba(247, 201, 132, 0.7) 0, transparent 60%);
      opacity: 0.7;
      filter: blur(4px);
    }

    /* Stylized bathhouse silhouette */
    .bathhouse-silhouette {
      position: fixed;
      bottom: 10vh;
      left: 50%;
      transform: translateX(-50%);
      width: 520px;
      height: 210px;
      pointer-events: none;
      z-index: -3;
    }

    .bathhouse-base,
    .bathhouse-mid,
    .bathhouse-top {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, #1f1016, #050307);
      border-radius: 6px;
      box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.8);
    }

    .bathhouse-base {
      bottom: 0;
      width: 100%;
      height: 72px;
    }

    .bathhouse-mid {
      bottom: 60px;
      width: 74%;
      height: 62px;
    }

    .bathhouse-top {
      bottom: 115px;
      width: 46%;
      height: 46px;
    }

    .bathhouse-roof {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 155px;
      width: 54%;
      height: 20px;
      background: linear-gradient(180deg, #3e151b, #150309);
      border-radius: 12px 12px 4px 4px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.75);
    }

    .bathhouse-roof::before,
    .bathhouse-roof::after {
      content: "";
      position: absolute;
      bottom: -3px;
      width: 26%;
      height: 12px;
      background: linear-gradient(180deg, #632326, #2a0507);
      border-radius: 10px 10px 3px 3px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.7);
    }

    .bathhouse-roof::before { left: 5%; }
    .bathhouse-roof::after { right: 5%; }

    .bathhouse-lights {
      position: absolute;
      inset: 20px 20px 26px;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: 14px;
      gap: 6px;
    }

    .bathhouse-light {
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #fff7d0 0, #f7c86a 45%, rgba(0, 0, 0, 0.6) 100%);
      opacity: 0.25;
    }

    .bathhouse-light:nth-child(3n) { opacity: 0.42; }
    .bathhouse-light:nth-child(5n) { opacity: 0.65; }

    .bathhouse-gate {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 72px;
      width: 24%;
      height: 46px;
      background: linear-gradient(180deg, #2d0e11, #140306);
      border-radius: 6px;
      box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bathhouse-gate::before {
      content: "";
      width: 65%;
      height: 60%;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 25%, #fff1c7 0, #f5c881 40%, transparent 80%);
      box-shadow: 0 0 18px rgba(247, 207, 140, 0.7);
    }

    .bathhouse-reflection {
      position: fixed;
      left: 50%;
      bottom: 4vh;
      transform: translateX(-50%) scaleY(-1);
      width: 480px;
      height: 90px;
      pointer-events: none;
      z-index: -2;
      opacity: 0.32;
      filter: blur(2.5px);
    }

    .bathhouse-reflection::before {
      content: "";
      position: absolute;
      inset: 12px 0 0;
      border-radius: 50%;
      background:
        radial-gradient(circle at 50% 0%, rgba(247, 201, 132, 0.55) 0, transparent 60%),
        radial-gradient(circle at 30% 0%, rgba(248, 240, 210, 0.4) 0, transparent 55%);
    }

    /* SPIRIT ORBS + LANTERNS */
    .spirit-orbs {
      pointer-events: none;
      position: fixed;
      inset: 0;
      z-index: -2;
    }

    .orb {
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.95) 0, rgba(159, 196, 255, 0.7) 40%, transparent 70%);
      box-shadow: 0 0 16px rgba(159, 196, 255, 0.9);
      animation: orb-drift 14s ease-in-out infinite alternate;
      opacity: 0.7;
    }

    .orb.o1 { top: 18%; left: 14%; animation-duration: 18s; }
    .orb.o2 { top: 28%; right: 16%; animation-duration: 16s; }
    .orb.o3 { top: 42%; left: 6%; animation-duration: 13s; }
    .orb.o4 { top: 52%; right: 8%; animation-duration: 19s; }
    .orb.o5 { top: 20%; left: 52%; animation-duration: 21s; }
    .orb.o6 { top: 34%; left: 32%; animation-duration: 15s; }

    @keyframes orb-drift {
      from { transform: translate3d(0, 0, 0); opacity: 0.5; }
      to { transform: translate3d(20px, -40px, 0); opacity: 1; }
    }

    .lantern {
      position: absolute;
      width: 30px;
      height: 52px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 50% 20%, #fff7dc 0, #f5d093 40%, #c86a4d 100%);
      box-shadow:
        0 0 18px rgba(245, 208, 147, 0.85),
        0 0 48px rgba(245, 208, 147, 0.55);
      opacity: 0.92;
      animation: lantern-float 11s ease-in-out infinite alternate;
    }

    .lantern::before {
      content: "";
      position: absolute;
      top: -14px;
      left: 50%;
      width: 1px;
      height: 18px;
      transform: translateX(-50%);
      background: rgba(248, 231, 198, 0.7);
    }

    .lantern.l1 { top: 12%; left: 20%; animation-duration: 14s; }
    .lantern.l2 { top: 7%; right: 16%; animation-duration: 12s; }
    .lantern.l3 { top: 24%; left: 68%; animation-duration: 18s; }
    .lantern.l4 { top: 18%; left: 8%; animation-duration: 20s; }

    @keyframes lantern-float {
      0% { transform: translateY(0) translateX(0); }
      50% { transform: translateY(-12px) translateX(4px); }
      100% { transform: translateY(-4px) translateX(-4px); }
    }

    /* floating fireflies */
    .fireflies {
      pointer-events: none;
      position: fixed;
      inset: 0;
      z-index: -1;
    }

    .firefly {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: radial-gradient(circle, #fffdd0 0, rgba(255, 255, 160, 0.8) 40%, transparent 70%);
      box-shadow: 0 0 10px rgba(255, 254, 200, 0.9);
      opacity: 0;
      animation: firefly-float 10s ease-in-out infinite;
    }

    .firefly.f1 { top: 18%; left: 25%; animation-duration: 11s; }
    .firefly.f2 { top: 10%; right: 22%; animation-duration: 9s; }
    .firefly.f3 { top: 26%; left: 55%; animation-duration: 13s; }
    .firefly.f4 { top: 32%; right: 8%; animation-duration: 12s; }
    .firefly.f5 { top: 20%; left: 8%; animation-duration: 14s; }

    @keyframes firefly-float {
      0%   { transform: translate(0, 0); opacity: 0; }
      15%  { opacity: 1; }
      50%  { transform: translate(25px, -20px); opacity: 0.6; }
      85%  { transform: translate(-10px, -30px); opacity: 1; }
      100% { transform: translate(0, -40px); opacity: 0; }
    }

    /* FOG */
    .scene-fog {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
      background:
        radial-gradient(circle at 20% 80%, rgba(191, 211, 232, 0.08) 0, transparent 55%),
        radial-gradient(circle at 80% 80%, rgba(198, 215, 226, 0.1) 0, transparent 55%);
      mix-blend-mode: screen;
      animation: fog-drift 40s linear infinite alternate;
    }

    @keyframes fog-drift {
      from { transform: translate3d(-10px, 0, 0); opacity: 0.8; }
      to { transform: translate3d(20px, -5px, 0); opacity: 1; }
    }

    /* FOREGROUND RAIL / BRIDGE */
    .scene-rail {
      position: fixed;
      left: -15%;
      right: -15%;
      bottom: 4vh;
      height: 56px;
      pointer-events: none;
      z-index: 0;
    }

    .rail-sleeper {
      position: absolute;
      bottom: 6px;
      width: 80px;
      height: 14px;
      background: linear-gradient(180deg, #2a130f, #080203);
      border-radius: 4px;
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.8);
    }

    .rail-track {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      height: 8px;
      border-radius: 8px;
      background:
        linear-gradient(180deg, #e7d7cf, #7c8593);
      box-shadow:
        0 3px 5px rgba(0, 0, 0, 0.9),
        0 -1px 0 rgba(255, 255, 255, 0.4);
    }

    .rail-track::before,
    .rail-track::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.3) 0, transparent 30%, transparent 70%, rgba(255, 255, 255, 0.3) 100%);
    }

    .rail-track::before { top: 0; opacity: 0.8; }
    .rail-track::after { bottom: 0; opacity: 0.4; }

    /* tiny soot-spirits along the tracks */
    .mini-soots {
      position: fixed;
      bottom: 2.8vh;
      left: 8%;
      right: 8%;
      pointer-events: none;
      z-index: 1;
    }

    .mini-soot {
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #050505;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.9);
    }

    .mini-soot::before,
    .mini-soot::after {
      content: "";
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #ffffff;
      top: 5px;
    }

    .mini-soot::before { left: 3px; }
    .mini-soot::after  { right: 3px; }

    .mini-soot.m1 { left: 12%; animation: mini-soot-hop 6s ease-in-out infinite; }
    .mini-soot.m2 { left: 38%; animation: mini-soot-hop 7s ease-in-out infinite 1s; }
    .mini-soot.m3 { left: 66%; animation: mini-soot-hop 5.5s ease-in-out infinite 0.5s; }

    @keyframes mini-soot-hop {
      0%, 100% { transform: translateY(0); }
      20% { transform: translateY(-4px); }
      40% { transform: translateY(0); }
      60% { transform: translateY(-2px); }
      80% { transform: translateY(0); }
    }

    /* APP LAYOUT */

    /* Subtle Ghibli-style scene life: fireflies, drifting fog, soft glow */
    /* Extra celebrations: last special word & all goals met */
    body.last-special-burst::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background:
        radial-gradient(circle at 20% 10%, rgba(255, 255, 255, 0.32) 0, transparent 55%),
        radial-gradient(circle at 80% 15%, rgba(255, 232, 185, 0.35) 0, transparent 60%);
      mix-blend-mode: screen;
      animation: last-special-flash 1200ms ease-out forwards;
    }

    @keyframes last-special-flash {
      0%   { opacity: 0; }
      20%  { opacity: 1; }
      60%  { opacity: 0.7; }
      100% { opacity: 0; }
    }

    body.goals-aura::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      background:
        radial-gradient(circle at 50% 100%, rgba(181, 214, 255, 0.4) 0, transparent 65%),
        radial-gradient(circle at 50% 0%, rgba(255, 210, 160, 0.35) 0, transparent 60%);
      mix-blend-mode: screen;
      animation: goals-aura-pulse 1600ms ease-out forwards;
    }

    @keyframes goals-aura-pulse {
      0%   { opacity: 0; }
      25%  { opacity: 1; }
      70%  { opacity: 0.8; }
      100% { opacity: 0; }
    }

    .scene-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    .firefly {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: radial-gradient(circle, #fffdd0 0, rgba(255, 255, 190, 0.8) 40%, transparent 70%);
      box-shadow: 0 0 12px rgba(255, 252, 200, 0.9);
      opacity: 0;
      animation: firefly-float 10s ease-in-out infinite;
    }

    .firefly.f1 { top: 18%; left: 14%; animation-duration: 12s; }
    .firefly.f2 { top: 26%; right: 12%; animation-duration: 14s; animation-delay: 2s; }
    .firefly.f3 { top: 40%; left: 8%; animation-duration: 11s; animation-delay: 1s; }
    .firefly.f4 { top: 30%; left: 55%; animation-duration: 13s; animation-delay: 3s; }
    .firefly.f5 { top: 22%; right: 30%; animation-duration: 15s; animation-delay: 4s; }

    @keyframes firefly-float {
      0%   { transform: translate(0, 0); opacity: 0; }
      15%  { opacity: 1; }
      50%  { transform: translate(24px, -20px); opacity: 0.7; }
      85%  { transform: translate(-12px, -32px); opacity: 1; }
      100% { transform: translate(0, -40px); opacity: 0; }
    }

    .fog-layer {
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 20% 80%, rgba(200, 220, 230, 0.08) 0, transparent 55%),
        radial-gradient(circle at 80% 82%, rgba(210, 228, 236, 0.1) 0, transparent 55%);
      mix-blend-mode: screen;
      opacity: 0.9;
      animation: fog-drift 40s linear infinite alternate;
    }

    @keyframes fog-drift {
      from { transform: translate3d(-12px, 0, 0); opacity: 0.65; }
      to   { transform: translate3d(18px, -4px, 0); opacity: 1; }
    }

    .scene-glow {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      /* Disabled on Squaredle so the background shows clearly */
      background: none;
      mix-blend-mode: normal;
      animation: none;
    }

    @keyframes glow-flicker {
      0%   { opacity: 0.75; }
      40%  { opacity: 1; }
      60%  { opacity: 0.7; }
      100% { opacity: 0.9; }
    }

    .app-shell {
      max-width: 1100px;
      width: 100%;
      margin: 40px auto;
      display: grid;
      grid-template-columns: minmax(0, 3.2fr) minmax(0, 2.8fr);
      gap: 24px;
      z-index: 1;
      position: relative;
    }

    /* Squaredle: visually unify the two halves into a single main card */
    #mode-squaredle .app-shell {
      background:
          linear-gradient(180deg, rgba(46, 26, 20, 0.45), rgba(22, 12, 10, 0.90)),
          radial-gradient(circle at top left, rgba(255, 239, 210, 0.18), transparent 60%);

      border-radius: 22px;

      /* Stronger warm perimeter glow */
      box-shadow:
        0 0 35px rgba(255, 240, 190, 0.45),
        0 0 75px rgba(255, 210, 140, 0.45),
        0 0 130px rgba(255, 225, 160, 0.45),
        0 28px 95px rgba(0, 0, 0, 0.95);

      border: 2px solid rgba(255, 231, 200, 0.88);

      padding: 20px 22px;
      overflow: visible;

      backdrop-filter: blur(13px) saturate(1.12);
      animation: edge-flicker 5.5s ease-in-out infinite alternate;
}

#mode-squaredle .app-shell::before {
  content: "";
  position: absolute;
  inset: 0; border-radius: 26px; mask-image: radial-gradient(circle, black 60%, transparent 100%);
  background:
    radial-gradient(circle at 20% 0%, rgba(255, 240, 200, 0.70), transparent 60%),
    radial-gradient(circle at 80% 0%, rgba(255, 210, 160, 0.52), transparent 60%);
  pointer-events: none;
  mix-blend-mode: screen;
  opacity: 0.7;
  animation: heat-shimmer 6s ease-in-out infinite alternate;
}

#mode-squaredle .app-shell::after {
  content: "";
  position: absolute;
  inset: -8px;
  pointer-events: none;
  border-radius: 26px;
  background-image:
    radial-gradient(circle, rgba(255, 210, 150, 0.75) 0, transparent 45%),
    radial-gradient(circle, rgba(255, 170, 110, 0.60) 0, transparent 50%),
    radial-gradient(circle, rgba(255, 235, 200, 0.85) 0, transparent 40%);
  background-repeat: no-repeat;
  background-size: 14px 14px, 10px 10px, 8px 8px;
  background-position:
    8% 16%,
    92% 24%,
    18% 88%;
  mix-blend-mode: screen;
  opacity: 0.0;
  animation: ember-drift 7s ease-in-out infinite alternate;
}


    #mode-squaredle .app-shell > .card {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      overflow: visible; /* allow mascot to extend into card edge without clipping */
    }

    #mode-squaredle .app-shell > .card::before {
      content: none;
      display: none;
    }


    @media (max-width: 900px) {
      .app-shell {
      max-width: 1100px;
      width: 100%;
      margin: 40px auto;
      display: grid;
      grid-template-columns: minmax(0, 3.2fr) minmax(0, 2.8fr);
      gap: 24px;
      z-index: 1;
      position: relative;
    }
    }

    .card {
      background:
        linear-gradient(180deg, rgba(46, 26, 20, 0.70), rgba(182, 52, 50, 0.90)),
        radial-gradient(circle at top left, rgba(255, 239, 210, 0.18), transparent 60%);
      border-radius: 22px;
      border: 1px solid rgba(248, 226, 188, 0.7);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.9),
        0 0 0 1px rgba(80, 40, 24, 0.5);
      padding: 20px 22px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(5px) saturate(1.1);
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -30%;
      background:
        radial-gradient(circle at 0% 0%, rgba(255, 241, 210, 0.22) 0, transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(255, 205, 150, 0.16) 0, transparent 55%);
      opacity: 0.9;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 18px;
    }

    .title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title-main {
      font-family: "Baloo 2", system-ui;
      font-size: 30px;
      letter-spacing: 0.08em;
      color: #ffe7c2;
      text-shadow:
        0 2px 0 #8a4036,
        0 8px 18px rgba(0, 0, 0, 0.85);
    }

    .title-sub {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--accent-strong);
      letter-spacing: 0.18em;
    }

    /* GRID */
    .grid-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .grid-wrapper.grid-sparkle {
      position: relative;
      overflow: visible;
    }

    .grid-wrapper.grid-sparkle::after {
      content: "";
      position: absolute;
      inset: -8px;
      border-radius: 30px;
      pointer-events: none;
      background:
        radial-gradient(circle at 10% 0%, rgba(255, 255, 255, 0.4) 0, transparent 50%),
        radial-gradient(circle at 90% 20%, rgba(255, 235, 185, 0.45) 0, transparent 55%),
        radial-gradient(circle at 40% 80%, rgba(181, 214, 255, 0.4) 0, transparent 60%);
      opacity: 0;
      animation: puzzle-sparkle 900ms ease-out forwards;
      mix-blend-mode: screen;
    }

    .grid-wrapper.grid-sparkle::before {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: 26px;
      border: 2px solid rgba(255, 238, 196, 0.9);
      box-shadow:
        0 0 12px rgba(255, 238, 196, 0.9),
        0 0 28px rgba(187, 215, 255, 0.9);
      opacity: 0;
      animation: puzzle-ring 900ms ease-out forwards;
      pointer-events: none;
    }

    @keyframes puzzle-sparkle {
      0%   { opacity: 0; transform: scale(1.0); }
      20%  { opacity: 1; transform: scale(1.02); }
      60%  { opacity: 0.9; transform: scale(1.0); }
      100% { opacity: 0; transform: scale(1.03); }
    }

    @keyframes puzzle-ring {
      0%   { opacity: 0; transform: scale(1.0); }
      25%  { opacity: 1; transform: scale(1.02); }
      80%  { opacity: 0.8; transform: scale(1.01); }
      100% { opacity: 0; transform: scale(1.05); }
    }
    

    .grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(56px, 1fr));
      gap: 12px;
      padding: 22px;
      background:
        radial-gradient(circle at 15% 0%, rgba(113, 111, 184, 0.5) 0, transparent 60%),
        radial-gradient(circle at 90% 0%, rgba(245, 178, 114, 0.55) 0, transparent 60%),
        linear-gradient(180deg, #211429, #24152a);
      border-radius: 26px;
      border: 2px solid #735286;
      box-shadow:
        0 16px 32px rgba(0, 0, 0, 0.9),
        inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      position: relative;
      max-width: 100%;
    }

    .grid::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(120deg, rgba(255, 255, 255, 0.15) 0, transparent 40%, transparent 60%, rgba(255, 255, 255, 0.1) 100%);
      mix-blend-mode: soft-light;
      opacity: 0.7;
      pointer-events: none;
    }

    /* gentle shimmer over grid */
    .grid::after {
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: inherit;
      background:
        radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.18) 0, transparent 45%),
        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.14) 0, transparent 50%);
      mix-blend-mode: screen;
      opacity: 0;
      pointer-events: none;
      animation: grid-shimmer 6s ease-in-out infinite;
    }

    @keyframes grid-shimmer {
      0%, 100% { opacity: 0; }
      35%      { opacity: 0.4; }
      55%      { opacity: 0.2; }
      75%      { opacity: 0.45; }
    }

    .tile {
      position: relative;
      aspect-ratio: 1 / 1;
      border-radius: 14px;
      background:
        radial-gradient(circle at 20% 0%, #5a3627 0, #2b140e 55%, #140807 100%);
      border: 1px solid rgba(203, 153, 107, 0.95);
      box-shadow:
        0 10px 20px rgba(0, 0, 0, 0.95),
        inset 0 0 0 1px rgba(0, 0, 0, 0.35);
      cursor: pointer;
      overflow: hidden;
      transition:
        transform 140ms ease-out,
        box-shadow 140ms ease-out,
        border-color 140ms ease-out,
        background 140ms ease-out;
      font-size: 32px;
      font-weight: 800;
      letter-spacing: 0.2em;
      color: #fdf3de;
      text-shadow:
        0 0 4px rgba(0, 0, 0, 0.8),
        0 0 10px rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tile:hover {
      transform: translateY(-2px);
      box-shadow:
        0 5px 0 #140609,
        0 15px 22px rgba(0, 0, 0, 0.9);
      filter: brightness(1.08);
      border-color: #f0c88c;
    }

    .tile.blank {
      background: radial-gradient(circle at 50% 20%, #2c2030, #140810);
      opacity: 0.16;
      box-shadow: none;
      border-style: dashed;
      cursor: default;
    }

    .tile.blank:hover {
      transform: none;
      box-shadow: none;
      filter: none;
    }

    .tile.selected {
      transform: translateY(-1px) scale(1.01);
      background:
        radial-gradient(circle at 20% 0%, #8b5434 0, #3b1d13 55%, #170a08 100%);
      border-color: #f5d39a;
      box-shadow:
        0 0 0 1px rgba(245, 211, 154, 0.85),
        0 0 16px rgba(247, 217, 171, 0.9),
        0 16px 32px rgba(0, 0, 0, 0.9);
    }

    .tile-index {
      position: absolute;
      bottom: 4px;
      right: 6px;
      font-size: 11px;
      color: var(--accent-strong);
      opacity: 0;
      transform: scale(0.5);
      transform-origin: 100% 100%;
      transition:
        opacity var(--transition-fast),
        transform var(--transition-fast);
      pointer-events: none;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    }

    .tile.selected .tile-index {
      opacity: 1;
      transform: scale(1);
    }

    /* HUD / CONTROLS */
    .hud {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }

    .current-word {
      font-size: 15px;
      padding: 7px 12px;
      border-radius: 999px;
      background: rgba(12, 9, 21, 0.9);
      border: 1px solid rgba(162, 126, 188, 0.9);
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .current-label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.16em;
    }

    .current-word-text {
      font-family: "Nunito", system-ui;
      font-weight: 800;
      letter-spacing: 0.22em;
      font-size: 16px;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #ffe8be;
    }

    button.control {
      border-radius: 999px;
      padding: 8px 16px;
      border: 1px solid rgba(172, 102, 97, 0.95);
      background: radial-gradient(circle at 30% 0%, #fbe7cc 0, #f4b07a 55%, #8d3235 100%);
      color: #2d0505;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow:
        0 3px 0 #5b1e1d,
        0 10px 18px rgba(0, 0, 0, 0.8);
      transition:
        background var(--transition-fast),
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        border-color var(--transition-fast);
    }

    button.control.secondary:hover {
      background: radial-gradient(circle at 20% 0%, #fff3dc 0, #f5c18d 55%, #9e4042 100%);
      transform: translateY(-1px);
      box-shadow:
        0 4px 0 #5b1e1d,
        0 13px 22px rgba(0, 0, 0, 0.95);
    }

    button.control:active {
      transform: translateY(0);
      box-shadow:
        0 2px 0 #471515,
        0 6px 10px rgba(0, 0, 0, 0.8);
    }

    button.control:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }

    .status-line {
      font-size: 12px;
      margin-top: 8px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-line strong {
      color: var(--accent-strong);
    }

    /* RIGHT PANEL - GOALS & WORDS */
    .goals-section {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .section-title {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.16em;
      margin-bottom: 6px;
    }

    .special-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .special-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(24, 15, 38, 0.96);
      border: 1px solid rgba(144, 104, 180, 0.9);
    }

    .special-left {
      display: flex;
      align-items: center;
      gap: 9px;
    }

    .special-word-label {
      font-family: "Nunito", system-ui;
      font-size: 18px;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--accent-strong);
    }

    .badge {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .badge.found {
      background: var(--accent-soft);
      color: var(--accent-strong);
      border: 1px solid rgba(240, 189, 120, 0.95);
    }

    .badge.missing {
      background: rgba(38, 24, 59, 0.95);
      color: var(--text-muted);
      border: 1px solid rgba(97, 70, 129, 0.9);
    }

    .check-circle {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 2px solid rgba(97, 70, 129, 0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: var(--accent-strong);
      background: #120a1f;
    }

    .check-circle.filled {
      border-color: rgba(240, 189, 120, 0.95);
      background: #3c293d;
    }

    .progress-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .progress-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
    }

    .progress-label {
      color: var(--text-muted);
    }

    .progress-nums {
      font-variant-numeric: tabular-nums;
      font-size: 12px;
      color: #ffe8c3;
    }

    .bar {
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: rgba(56, 36, 78, 0.9);
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      position: absolute;
      inset: 0;
      width: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, #f5d89b, #f26f80, #a980e6);
      transition: width 180ms.ease-out;
    }

    .words-section {
      margin-top: 12px;
    }

    .words-list {
      max-height: 230px;
      overflow: auto;
      padding-right: 4px;
      margin-top: 6px;
      border-radius: 16px;
      background: rgba(16, 10, 30, 0.98);
      border: 1px solid rgba(90, 64, 122, 0.9);
    }

    .words-inner {
      padding: 8px 10px 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .word-chip {
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(56, 33, 83, 0.95);
      border: 1px solid rgba(143, 110, 197, 0.9);
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: #f3e6ff;
      font-family: "Nunito", system-ui;
      font-weight: 700;
    }

    .word-chip.special {
      background: rgba(134, 88, 139, 0.95);
      border-color: rgba(245, 195, 122, 0.95);
      color: #ffe7c3;
    }

    .word-chip span {
      font-size: 9px;
      opacity: 0.75;
      margin-left: 4px;
      font-family: "Nunito", system-ui;
    }

    /* Toast / Banner */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(120%);
      background: rgba(16, 9, 29, 0.98);
      border-radius: 999px;
      padding: 8px 16px;
      border: 1px solid rgba(164, 121, 198, 0.9);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 20;
      opacity: 0;
      box-shadow: 0 14px 26px rgba(0, 0, 0, 0.95);
      transition:
        opacity 140ms ease-out,
        transform 140ms ease-out;
      color: #ffe7d7;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast.good {
      border-color: rgba(242, 189, 120, 0.95);
    }

    .toast.bad {
      border-color: rgba(242, 111, 128, 0.9);
      background: rgba(40, 12, 24, 0.98);
    }

    .toast-emoji {
      font-size: 18px;
    }

    /* Completion Overlay */
    .overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 220ms.ease-out;
      z-index: 30;
    }

    .overlay.show {
      pointer-events: auto;
      opacity: 1;
    }

    .overlay-backdrop {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(248, 214, 150, 0.4), rgba(8, 2, 17, 0.95));
      backdrop-filter: blur(5px);
    }

    .overlay-card {
      position: relative;
      z-index: 1;
      background: radial-gradient(circle at top, #2c1832, #130919);
      border-radius: 24px;
      padding: 24px 26px;
      border: 1px solid rgba(242, 189, 120, 0.95);
      box-shadow:
        0 22px 45px rgba(0, 0, 0, 0.95),
        0 0 0 1px rgba(255, 255, 255, 0.08);
      max-width: 420px;
      text-align: center;
      animation: pop-in 240ms.ease-out;
      color: #ffe7c5;
    }

    .overlay-title {
      font-family: "Baloo 2", system-ui;
      font-size: 26px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .overlay-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .overlay-words {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }

    .confetti {
      position: absolute;
      width: 6px;
      height: 12px;
      border-radius: 2px;
      background: #f9d27a;
      top: 0;
      left: 50%;
      opacity: 0;
      animation: confetti-drop 900ms.ease-out forwards;
    }

    @keyframes pop-in {
      from {
        transform: scale(1.0) translateY(10px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    @keyframes confetti-drop {
      0% {
        transform: translateX(-50%) translateY(-20px) rotate(0deg);
        opacity: 0;
      }
      15% {
        opacity: 1;
      }
      100% {
        transform: translateX(var(--x-offset, 0)) translateY(220px) rotate(290deg);
        opacity: 0;
      }
    }

    /* FROG / TOAD MASCOT – illustrated image with moods */
    .mascot {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 18px;
    }

    .mascot-figure {
      width: 160px;
      height: 160px;
      position: relative;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      filter: drop-shadow(0 8px 10px rgba(0, 0, 0, 0.9));
    }

    .mascot-image {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
      transform-origin: 50% 100%;
      image-rendering: auto;
    }

    /* Base idle animation – overridden by moods */
    .mascot.mood-soft .mascot-image {
      animation: mascot-soft 3.6s ease-in-out infinite;
    }

    .mascot.mood-shy .mascot-image {
      animation: mascot-shy 3.6s ease-in-out infinite;
      transform-origin: 50% 100%;
    }

    .mascot.mood-mischief .mascot-image {
      animation: mascot-mischief 2.4s ease-in-out infinite;
    }

    .mascot.mood-excited .mascot-image {
      animation: mascot-excited 1.6s ease-in-out infinite;
    }

    .mascot.dancing .mascot-image {
      animation: mascot-dance 0.9s ease-in-out infinite;
    }

    @keyframes mascot-soft {
      0%, 100% { transform: translateY(0) scale(1); }
      25% { transform: translateY(-2px) scale(1.01); }
      50% { transform: translateY(0) scale(1.01); }
      75% { transform: translateY(-1px) scale(1.005); }
    }

    @keyframes mascot-shy {
      0%, 100% { transform: translateY(1px) scale(1); }
      30% { transform: translateY(0) scale(1.02); }
      60% { transform: translateY(2px) scale(1.01); }
    }

    @keyframes mascot-mischief {
      0%, 100% { transform: translateY(-1px) rotate(0deg) scale(1); }
      25% { transform: translateY(-2px) rotate(-3deg) scale(1.02); }
      50% { transform: translateY(-1px) rotate(3deg) scale(1.02); }
      75% { transform: translateY(-2px) rotate(-2deg) scale(1.01); }
    }

    @keyframes mascot-excited {
      0%, 100% { transform: translateY(0) scale(1); }
      30% { transform: translateY(-4px) scale(1.04); }
      60% { transform: translateY(-2px) scale(1.03); }
    }

    @keyframes mascot-dance {
      0%, 100% { transform: translateY(0) scale(1); }
      25% { transform: translateY(-9px) scale(1.05); }
      50% { transform: translateY(-3px) scale(1.03); }
      75% { transform: translateY(-7px) scale(1.04); }
    }

    .mascot-speech {
      background:
        linear-gradient(180deg, rgba(32, 18, 12, 0.96), rgba(22, 12, 10, 0.98));
      border-radius: 18px;
      border: 1px solid rgba(248, 226, 188, 0.7);
      padding: 10px 12px;
      font-size: 13px;
      color: #fcebd4;
      box-shadow:
        0 10px 24px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(70, 35, 20, 0.6);
    }

    .mascot-speech::before {
      content: "";
      position: absolute;
      left: -8px;
      bottom: 6px;
      width: 12px;
      height: 12px;
      background: inherit;
      border-left: inherit;
      border-bottom: inherit;
      transform: rotate(45deg);
      border-radius: 0 0 0 8px;
    }
  
  /* === Mode selector: Squaredle / Kiki's Connections === */
  .mode-switch {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 16px auto 10px;
    max-width: 640px;
    position: relative;
    z-index: 5;
  }

  .mode-button {
    border: none;
    outline: none;
    border-radius: 999px;
    padding: 8px 18px;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.45);
    color: #fdf6ec;
    border: 1px solid rgba(255, 255, 255, 0.35);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.45);
    transition:
      background 0.15s ease-out,
      transform 0.15s ease-out,
      box-shadow 0.15s ease-out,
      color 0.15s ease-out,
      border-color 0.15s ease-out;
  }

  .mode-button:hover {
    transform: translateY(-1px);
    background: rgba(255, 255, 255, 0.16);
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.55);
  }

  .mode-button.active {
    background: linear-gradient(135deg, #ffe7f0, #f9f0ff);
    color: #1b1027;
    border-color: rgba(255, 255, 255, 0.95);
  }

  .mode-panel-container {
    max-width: 1080px;
    width: 100%;
    margin: 0 auto 24px;
    position: relative;
    z-index: 1;
  }

  .mode-panel {
    display: none;
  }

  .mode-panel.active {
    display: block;
  }

  /* Body theming when in Kiki Connections mode */
  body.connections-mode {
    background-image: url('KikisBackground.png');
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-color: #020711;
  }

  body.connections-mode .scene-overlay,
  body.connections-mode .scene-glow {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      /* Disabled on Squaredle so the background shows clearly */
      background: none;
      mix-blend-mode: normal;
      animation: none;
    }

  /* Connections card + layout */
  #mode-connections .card {
    background:
      radial-gradient(circle at 8% 0%, rgba(255, 210, 255, 0.55) 0, transparent 55%),
      radial-gradient(circle at 92% 0%, rgba(221, 227, 255, 0.38) 0, transparent 55%),
      linear-gradient(180deg, rgba(80, 2, 220, 0.50), rgba(32, 1, 24, 0.90));
    border-radius: 24px;
    border: 1px solid rgba(252, 232, 210, 0.95);
    box-shadow:
      0 22px 46px rgba(6, 5, 18, 0.96),
      0 0 0 1px rgba(120, 82, 90, 0.45);
    backdrop-filter: blur(22px) saturate(1.05);
    padding: 20px 26px 22px;
  }

  .connections-panel .card-header .title-main {
    font-size: 1.7rem;
  }
  #mode-connections .card.connections-panel {
    margin: 80px auto 64px;
    max-width: 1100px;
  }


  .connections-panel .card-header {
    justify-content: center;
    text-align: center;
  }

  .connections-body {
    align-items: center;
  }

  .connections-main {
    gap: 16px;
  }

  .connections-hud {
    justify-content: center;
  }

  .connections-solved-groups {
    margin-top: 10px;
  }

  .connections-body {
    display: grid;
    grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
    gap: 20px;
    align-items: flex-start;
  }

  @media (max-width: 960px) {
    .connections-body {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  .connections-main {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  /* Grid: no extra card wrapper, simple layout */
  .connections-grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 10px;
    margin-top: 4px;
  }

  .connections-tile {
    position: relative;
    border-radius: 14px;
    background:
      linear-gradient(135deg, #fff9f0, #ffe2c9);
    border: 1px solid rgba(255, 255, 255, 0.9);
    box-shadow:
      0 8px 16px rgba(65, 40, 22, 0.35);
    cursor: pointer;
    overflow: hidden;
    transition:
      transform 140ms ease-out,
      box-shadow 140ms ease-out,
      border-color 140ms ease-out,
      background 140ms ease-out,
      color 140ms ease-out;
    font-size: 13px;
    font-weight: 700;
    color: #3b2640;
    text-shadow:
      0 0 3px rgba(255, 255, 255, 0.6),
      0 0 10px rgba(0, 0, 0, 0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 8px;
    min-height: 60px;
  }

  .connections-tile:hover {
    transform: translateY(-2px);
    box-shadow:
      0 8px 18px rgba(80, 44, 24, 0.5);
    filter: brightness(1.03);
    border-color: #ffddaa;
  }

  .connections-tile.selected {
    transform: translateY(-1px) scale(1.01);
    background:
      linear-gradient(135deg, #fff4df, #ffd9a3);
    border-color: #ffe2b1;
    box-shadow:
      0 0 0 1px rgba(255, 232, 191, 0.9),
      0 0 18px rgba(255, 216, 165, 0.85),
      0 12px 24px rgba(68, 38, 20, 0.55);
  }

  .connections-tile.solved {
    cursor: default;
    transform: translateY(0);
    box-shadow:
      0 6px 14px rgba(0, 0, 0, 0.25);
  }

  /* Pastel gradient category fills */
  .connections-tile.category-yellow {
    background: linear-gradient(135deg, #fff9da, #ffe3a9);
  }

  .connections-tile.category-green {
    background: linear-gradient(135deg, #e8ffe5, #b8e8c0);
  }

  .connections-tile.category-blue {
    background: linear-gradient(135deg, #e6f4ff, #a8d4ff);
    color: #042341;
  }

  .connections-tile.category-purple {
    background: linear-gradient(135deg, #f5e6ff, #dab6ff);
  }

  .connections-status-row {
    margin-top: 6px;
    display: flex;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    font-size: 12px;
  }

  .connections-status-message {
    min-height: 18px;
  }

  .connections-status-message.success { color: #e9ffe0; }
  .connections-status-message.error   { color: #ffb3b3; }
  .connections-status-message.subtle  { color: #e0d7f2; }

  .connections-strikes {
    font-size: 12px;
    letter-spacing: 0.02em;
  }

  .connections-strike-dot {
    display: inline-block;
    width: 9px;
    height: 9px;
    border-radius: 50%;
    margin-left: 3px;
    background: rgba(255, 255, 255, 0.23);
    box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.4);
  }

  .connections-strike-dot.used {
    background: #ffb3b3;
  }

  .connections-solved-groups {
    margin-top: 14px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .connections-group-row-label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    border-radius: 999px;
    font-size: 16px;
    font-weight: 700;
    text-transform: none;
    letter-spacing: 0.02em;
    color: #000;
    background: linear-gradient(135deg, #fffdf8, #f1e4d6);
    box-shadow:
      0 4px 10px rgba(0, 0, 0, 0.14),
      0 0 0 1px rgba(255, 255, 255, 0.9);
  }

  .connections-group-pill {
    width: 12px;
    height: 12px;
    border-radius: 999px;
    box-shadow:
      0 0 0 1px rgba(0, 0, 0, 0.2),
      0 0 6px rgba(255, 255, 255, 0.85);
  }

  .connections-group-pill.blue {
    background: linear-gradient(135deg, #e6f4ff, #a8d4ff);
  }

  .connections-group-pill.green {
    background: linear-gradient(135deg, #e8ffe5, #b8e8c0);
  }

  .connections-group-pill.yellow {
    background: linear-gradient(135deg, #fff9da, #ffe3a9);
  }

  .connections-group-pill.purple {
    background: linear-gradient(135deg, #f5e6ff, #dab6ff);
  }

  .connections-hud {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 8px;
  }

  .connections-side {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .connections-footer-note {
    font-size: 11px;
    opacity: 0.9;
  }

  /* Mouse mascot for Connections, without circular backdrop */
  .connections-mascot {
    display: flex;
    align-items: flex-start;
    gap: 14px;
  }

  .connections-mascot-figure {
    width: 96px;
    height: auto;
    position: relative;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    filter: drop-shadow(0 6px 8px rgba(0, 0, 0, 0.7));
  }

  .connections-mascot-image-wrap {
    width: 100%;
    height: auto;
    padding: 0;
    border-radius: 0;
    background: none;
    box-shadow: none;
    display: flex;
    align-items: flex-end;
    justify-content: center;
  }

  .connections-mascot-image {
    width: 100%;
    height: auto;
    display: block;
    transform-origin: 50% 100%;
    image-rendering: auto;
  }

  .connections-mascot-speech {
    background:
      linear-gradient(180deg, rgba(255, 249, 238, 0.98), rgba(255, 237, 208, 0.98));
    border-radius: 16px;
    border: 1px solid rgba(203, 153, 107, 0.8);
    padding: 8px 11px;
    font-size: 12px;
    color: #402020;
    max-width: 260px;
    box-shadow:
      0 10px 24px rgba(0, 0, 0, 0.45),
      0 0 0 1px rgba(70, 35, 20, 0.4);
    position: relative;
  }

  .connections-mascot-speech::before {
    content: "";
    position: absolute;
    left: -7px;
    bottom: 8px;
    width: 11px;
    height: 11px;
    background: inherit;
    border-left: inherit;
    border-bottom: inherit;
    transform: rotate(45deg);
    border-radius: 0 0 0 8px;
  }

  .connections-mascot.mood-soft .connections-mascot-image {
    animation: connMascotSoft 3.6s ease-in-out infinite;
  }

  .connections-mascot.mood-excited .connections-mascot-image {
    animation: connMascotExcited 1.8s ease-in-out infinite;
  }

  .connections-mascot.mood-idea .connections-mascot-image {
    animation: connMascotThinking 3.2s ease-in-out infinite;
  }

  .connections-mascot.mood-explaining .connections-mascot-image {
    animation: connMascotSoft 2.8s ease-in-out infinite;
  }

  .connections-mascot.mood-happy .connections-mascot-image {
    animation: connMascotExcited 2.2s ease-in-out infinite;
  }

  @keyframes connMascotSoft {
    0%, 100% { transform: translateY(0) scale(1); }
    25% { transform: translateY(-2px) scale(1.01); }
    50% { transform: translateY(0) scale(1.01); }
    75% { transform: translateY(-1px) scale(1.005); }
  }

  @keyframes connMascotExcited {
    0%, 100% { transform: translateY(0) scale(1); }
    25% { transform: translateY(-8px) scale(1.05); }
    50% { transform: translateY(-3px) scale(1.02); }
    75% { transform: translateY(-6px) scale(1.04); }
  }

  @keyframes connMascotThinking {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    30% { transform: translateY(-2px) rotate(-2deg); }
    60% { transform: translateY(0) rotate(2deg); }
  }

    /* === Squaredle: Heart of the Puzzle – dual-layer bloom + embers === */
    body.heart-bloom-active::before,
    body.heart-bloom-active::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 5;
      opacity: 0;
      mix-blend-mode: screen;
    }

    body.heart-bloom-active::before {
      /* inner warm heart-ish glow */
      background:
        radial-gradient(circle at 50% 45%, rgba(255, 214, 231, 0.98) 0, rgba(255, 214, 231, 0.0) 32%),
        radial-gradient(circle at 40% 40%, rgba(255, 248, 230, 0.9) 0, rgba(255, 248, 230, 0.0) 38%),
        radial-gradient(circle at 60% 40%, rgba(255, 238, 220, 0.9) 0, rgba(255, 238, 220, 0.0) 38%);
      animation: heart-bloom-core 3600ms ease-out forwards;
    }

    body.heart-bloom-active::after {
      /* outer circular magical pulse */
      background:
        radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.7) 0, rgba(255, 255, 255, 0.0) 45%),
        radial-gradient(circle at 50% 50%, rgba(255, 205, 220, 0.35) 0, rgba(255, 205, 220, 0.0) 80%);
      animation: heart-bloom-halo 3800ms ease-out forwards;
    }

    .heart-ember-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 6;
      overflow: hidden;
    }

    .heart-ember {
      position: absolute;
      width: 7px;
      height: 12px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fffdf5 0, #ffe0b8 35%, #ff9fb0 100%);
      box-shadow:
        0 0 6px rgba(255, 250, 240, 0.9),
        0 0 14px rgba(255, 190, 210, 0.85);
      opacity: 0;
      transform-origin: 50% 100%;
      animation-fill-mode: forwards;
    }

    @keyframes heart-bloom-core {
      0% {
        opacity: 0;
        transform: scale(0.4);
      }
      18% {
        opacity: 1;
        transform: scale(1.02);
      }
      55% {
        opacity: 0.96;
        transform: scale(1.12);
      }
      100% {
        opacity: 0;
        transform: scale(1.24);
      }
    }

    @keyframes heart-bloom-halo {
      0% {
        opacity: 0;
        transform: scale(1.0);
      }
      20% {
        opacity: 0.9;
        transform: scale(1.05);
      }
      60% {
        opacity: 0.7;
        transform: scale(1.25);
      }
      100% {
        opacity: 0;
        transform: scale(1.5);
      }
    }

    @keyframes heart-ember-rise {
      0% {
        opacity: 0;
        transform: translate3d(0, 12px, 0) scale(0.7) rotate(0deg);
      }
      15% {
        opacity: 1;
      }
      55% {
        transform: translate3d(0, -32px, 0) scale(1.05) rotate(10deg);
      }
      100% {
        opacity: 0;
        transform: translate3d(0, -64px, 0) scale(1.0) rotate(-6deg);
      }
    }

    /* === Connections: Ghibli-style wind gust + swirling petals + Jiji's blessing === */
    body.connections-mode.connections-gust-active::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 5;
      background:
        linear-gradient(110deg,
          rgba(255, 255, 255, 0.0) 0%,
          rgba(255, 240, 252, 0.42) 28%,
          rgba(227, 242, 255, 0.26) 55%,
          rgba(0, 0, 0, 0.0) 90%);
      opacity: 0;
      mix-blend-mode: screen;
      animation: connections-gust-sweep 2600ms ease-out forwards;
    }

    @keyframes connections-gust-sweep {
      0% {
        opacity: 0;
        transform: translateX(-12%);
      }
      20% {
        opacity: 1;
        transform: translateX(0);
      }
      65% {
        opacity: 0.9;
        transform: translateX(4%);
      }
      100% {
        opacity: 0;
        transform: translateX(10%);
      }
    }

    .connections-petal-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 6;
    }

    .petal {
      position: absolute;
      width: 18px;
      height: 12px;
      border-radius: 999px 999px 999px 999px;
      background: radial-gradient(circle at 30% 30%, #ffeef6 0, #f6c5d6 45%, #f19abf 100%);
      opacity: 0;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
      transform-origin: center;
      animation-timing-function: ease-out;
      animation-fill-mode: forwards;
    }

    .petal.path-1 { animation-name: petal-path-1; }
    .petal.path-2 { animation-name: petal-path-2; }
    .petal.path-3 { animation-name: petal-path-3; }

    @keyframes petal-path-1 {
      0% {
        opacity: 0;
        transform: translate3d(-10vw, -10vh, 0) rotate(0deg);
      }
      15% {
        opacity: 1;
      }
      45% {
        transform: translate3d(20vw, 20vh, 0) rotate(40deg);
      }
      80% {
        transform: translate3d(50vw, 40vh, 0) rotate(80deg);
      }
      100% {
        opacity: 0;
        transform: translate3d(70vw, 60vh, 0) rotate(120deg);
      }
    }

    @keyframes petal-path-2 {
      0% {
        opacity: 0;
        transform: translate3d(0vw, -12vh, 0) rotate(-10deg);
      }
      10% {
        opacity: 1;
      }
      35% {
        transform: translate3d(15vw, 10vh, 0) rotate(15deg);
      }
      70% {
        transform: translate3d(5vw, 35vh, 0) rotate(-25deg);
      }
      100% {
        opacity: 0;
        transform: translate3d(25vw, 55vh, 0) rotate(-40deg);
      }
    }

    @keyframes petal-path-3 {
      0% {
        opacity: 0;
        transform: translate3d(-5vw, -8vh, 0) rotate(20deg);
      }
      20% {
        opacity: 1;
      }
      40% {
        transform: translate3d(5vw, 6vh, 0) rotate(-10deg);
      }
      65% {
        transform: translate3d(-2vw, 24vh, 0) rotate(25deg);
      }
      100% {
        opacity: 0;
        transform: translate3d(10vw, 48vh, 0) rotate(60deg);
      }
    }

    body.connections-mode.connections-gust-active .connections-mascot {
      transform-origin: 50% 100%;
      animation: jiji-blessing-bounce 1800ms ease-out 1;
    }

    @keyframes jiji-blessing-bounce {
      0%   { transform: translateY(0) scale(1); }
      20%  { transform: translateY(-6px) scale(1.03); }
      40%  { transform: translateY(0) scale(1.01); }
      60%  { transform: translateY(-4px) scale(1.02); }
      100% { transform: translateY(0) scale(1); }
    }


  /* Wordle of the Fireflies mode background */
  body.fireflies-mode {
    background-image: url('fireflies.jpg');
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-color: #05040a;
  }

  body.fireflies-mode .scene-overlay,
  body.fireflies-mode .scene-glow {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      /* Disabled on Squaredle so the background shows clearly */
      background: none;
      mix-blend-mode: normal;
      animation: none;
    }

  /* Wordle of the Fireflies layout */
  .fireflies-app {
    max-width: 960px;
    margin: 48px auto;
    display: flex;
    justify-content: center;
  }

  .fireflies-card {
    background: radial-gradient(circle at 20% 0%, rgba(255, 205, 105, 0.20) 0, rgba(1, 24, 20, 0.90) 55%, rgba(4, 3, 10, 0.99) 100%);
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.16);
    box-shadow:
      0 28px 60px rgba(0, 0, 0, 0.9),
      0 0 0 1px rgba(255, 255, 255, 0.06);
    padding: 18px 20px 20px;
    backdrop-filter: blur(18px);
  }

  .fireflies-header .title-main {
    font-size: 26px;
    letter-spacing: 0.08em;
  }

  .fireflies-header .title-sub {
    font-size: 13px;
    opacity: 0.9;
  }

  .fireflies-layout {
    display: grid;
    grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
    gap: 20px;
    margin-top: 14px;
    align-items: stretch;
  }

  @media (max-width: 820px) {
    .fireflies-layout {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  .fireflies-play {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .fireflies-grid {
    display: grid;
    grid-template-rows: repeat(6, minmax(0, 1fr));
    gap: 6px;
  }

  .fireflies-row {
    display: grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: 6px;
  }

  .fireflies-tile {
    position: relative;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-height: 46px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: #fdfaf5;
    background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.1) 0, rgba(24, 20, 40, 0.95) 50%, rgba(10, 7, 18, 1) 100%);
    box-shadow:
      0 10px 20px rgba(0, 0, 0, 0.7),
      0 0 0 1px rgba(255, 255, 255, 0.04);
  }

  .fireflies-tile.pop {
    animation: fireflies-tile-pop 150ms ease-out;
  }

  @keyframes fireflies-tile-pop {
    0% { transform: scale(1.0); }
    60% { transform: scale(1.04); }
    100% { transform: scale(1); }
  }

  .fireflies-tile.state-correct {
    background: linear-gradient(135deg, #7bd089, #4a9f5b);
    border-color: rgba(10, 35, 18, 0.9);
    color: #071108;
  }

  .fireflies-tile.state-present {
    background: linear-gradient(135deg, #f1d165, #c8a53d);
    border-color: rgba(53, 36, 4, 0.9);
    color: #0f0903;
  }

  .fireflies-tile.state-absent {
    background: radial-gradient(circle at 20% 0%, rgba(255, 255, 255, 0.08) 0, rgba(40, 40, 54, 0.98) 60%, rgba(9, 9, 16, 1) 100%);
    border-color: rgba(120, 120, 150, 0.6);
    color: #b5b8c7;
  }

  .fireflies-keyboard {
    display: grid;
    gap: 6px;
    margin-top: 6px;
  }

  .fireflies-keyboard-row {
    display: flex;
    justify-content: center;
    gap: 6px;
  }

  .fireflies-key {
    border-radius: 7px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    padding: 8px 10px;
    min-width: 32px;
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    background: radial-gradient(circle at 10% 0%, rgba(255, 255, 255, 0.1) 0, rgba(26, 23, 40, 0.98) 60%, rgba(10, 7, 14, 1) 100%);
    color: #fdfbf6;
    cursor: pointer;
    box-shadow:
      0 6px 14px rgba(0, 0, 0, 0.7),
      0 0 0 1px rgba(255, 255, 255, 0.05);
    user-select: none;
  }

  .fireflies-key.wide {
    flex: 1.3;
    text-transform: none;
    font-size: 12px;
  }

  .fireflies-key.state-correct {
    background: linear-gradient(135deg, #7bd089, #4a9f5b);
    border-color: rgba(10, 35, 18, 0.9);
    color: #071108;
  }

  .fireflies-key.state-present {
    background: linear-gradient(135deg, #f1d165, #c8a53d);
    border-color: rgba(53, 36, 4, 0.9);
    color: #0f0903;
  }

  .fireflies-key.state-absent {
    background: radial-gradient(circle at 20% 0%, rgba(255, 255, 255, 0.06) 0, rgba(26, 26, 32, 0.98) 60%, rgba(8, 8, 14, 1) 100%);
    border-color: rgba(90, 90, 110, 0.9);
    color: #888da3;
  }

  .fireflies-status {
    min-height: 20px;
    font-size: 13px;
    color: #fdf6d0;
    opacity: 0.9;
  }

  .fireflies-mascot-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .fireflies-mascot {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .fireflies-mascot-figure {
    width: 150px;
    max-width: 180px;
  }

  .fireflies-mascot-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .fireflies-mascot-speech {
    position: relative;
    max-width: 260px;
    padding: 10px 14px;
    border-radius: 16px;
    background: radial-gradient(circle at 0 0, rgba(255, 255, 255, 0.22) 0, rgba(18, 14, 30, 0.95) 55%, rgba(8, 6, 15, 1) 100%);
    border: 1px solid rgba(255, 255, 255, 0.16);
    color: #fdfbf6;
    font-size: 13px;
    line-height: 1.45;
    box-shadow:
      0 12px 24px rgba(0, 0, 0, 0.7),
      0 0 0 1px rgba(255, 255, 255, 0.06);
  }

  .fireflies-mascot-speech::before {
    content: "";
    position: absolute;
    left: -8px;
    bottom: 10px;
    width: 12px;
    height: 12px;
    background: inherit;
    border-left: inherit;
    border-bottom: inherit;
    transform: rotate(45deg);
    border-radius: 0 0 0 6px;
  }

  /* Persistent background fireflies for Wordle of the Fireflies */
  .fireflies-background-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1;
    overflow: hidden;
  }

  .firefly-bg {
    position: absolute;
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: radial-gradient(circle at 30% 30%, #fffce9 0, #ffe58a 40%, #ffb347 100%);
    opacity: 0;
    box-shadow:
      0 0 6px rgba(255, 244, 200, 0.9),
      0 0 18px rgba(255, 210, 130, 0.85);
    animation-name: firefly-bg-float;
    animation-timing-function: ease-in-out;
    animation-iteration-count: infinite;
  }

  @keyframes firefly-bg-float {
    0% {
      opacity: 0;
      transform: translate3d(0, 10px, 0) scale(0.6);
    }
    20% {
      opacity: 1;
    }
    50% {
      transform: translate3d(20px, -20px, 0) scale(1.05);
    }
    100% {
      opacity: 0;
      transform: translate3d(-10px, -40px, 0) scale(0.7);
    }
  }

  /* Win celebration swarm */
  .fireflies-swarm-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 7;
    overflow: hidden;
  }

  .firefly-swarm {
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: radial-gradient(circle at 30% 30%, #fffbe8 0, #ffd86a 45%, #ffae3d 100%);
    box-shadow:
      0 0 8px rgba(255, 244, 200, 0.95),
      0 0 22px rgba(255, 210, 130, 0.9);
    opacity: 0;
    transform-origin: 50% 50%;
    animation-timing-function: ease-out;
    animation-fill-mode: forwards;
  }

  .firefly-swarm.swirl-a {
    animation-name: firefly-swarm-swirl-a;
  }

  .firefly-swarm.swirl-b {
    animation-name: firefly-swarm-swirl-b;
  }

  .firefly-swarm.swirl-c {
    animation-name: firefly-swarm-swirl-c;
  }

  @keyframes firefly-swarm-swirl-a {
    0% {
      opacity: 0;
      transform: translate3d(-10px, 20px, 0) scale(0.6);
    }
    20% {
      opacity: 1;
    }
    45% {
      transform: translate3d(30px, -40px, 0) scale(1.05);
    }
    75% {
      transform: translate3d(-10px, -90px, 0) scale(1.0);
    }
    100% {
      opacity: 0;
      transform: translate3d(40px, -140px, 0) scale(1.0);
    }
  }

  @keyframes firefly-swarm-swirl-b {
    0% {
      opacity: 0;
      transform: translate3d(10px, 20px, 0) scale(0.7);
    }
    20% {
      opacity: 1;
    }
    50% {
      transform: translate3d(-25px, -50px, 0) scale(1.1);
    }
    80% {
      transform: translate3d(15px, -110px, 0) scale(1.0);
    }
    100% {
      opacity: 0;
      transform: translate3d(-30px, -160px, 0) scale(1.0);
    }
  }

  @keyframes firefly-swarm-swirl-c {
    0% {
      opacity: 0;
      transform: translate3d(0, 20px, 0) scale(0.65);
    }
    20% {
      opacity: 1;
    }
    40% {
      transform: translate3d(22px, -38px, 0) scale(1.05);
    }
    70% {
      transform: translate3d(-22px, -100px, 0) scale(1.0);
    }
    100% {
      opacity: 0;
      transform: translate3d(0, -160px, 0) scale(1.0);
    }
  }


/* Squaredle-specific: remove inner card delineation so the whole area feels like one warm, continuous space */
#mode-squaredle .app-shell .card {
  background: transparent;
  border: none;
  box-shadow: none;
  border-radius: 24px;
  padding: 0;
  backdrop-filter: none;
}

/* Let the main app-shell padding control spacing instead */
#mode-squaredle .app-shell .card > *:first-child {
  margin-top: 4px;
}

/* Squaredle-specific: let the grid sit directly on the main card background */
#mode-squaredle .grid {
  background: transparent;
  border: none;
  box-shadow: none;
}

/* Squaredle-specific: make the found-words panel blend into the main card */
#mode-squaredle .words-list {
  background: transparent;
  border-color: transparent;
  box-shadow: none;
}

/* Keep the word chips readable by giving their container a bit more breathing room */
#mode-squaredle .words-inner {
  padding-top: 10px;
}

/* Squaredle firelight special effects */
@keyframes ember-drift {
  0% {
    opacity: 0.0;
    transform: translate3d(0, 0, 0) scale(1);
    filter: blur(0.2px);
  }
  25% {
    opacity: 0.55;
    transform: translate3d(1px, -2px, 0) scale(1.02);
  }
  50% {
    opacity: 0.85;
    transform: translate3d(-2px, -4px, 0) scale(1.05);
  }
  75% {
    opacity: 0.55;
    transform: translate3d(2px, -6px, 0) scale(1.02);
  }
  100% {
    opacity: 0.15;
    transform: translate3d(-1px, -8px, 0) scale(1.0);
    filter: blur(0.5px);
  }
}

@keyframes heat-shimmer {
  0% {
    opacity: 0.55;
    transform: translate3d(0, 0, 0) scale(1.00);
    filter: blur(0.0px);
  }
  35% {
    opacity: 0.72;
    transform: translate3d(0, -1px, 0) scale(1.015);
    filter: blur(0.3px);
  }
  65% {
    opacity: 0.62;
    transform: translate3d(0, 1px, 0) scale(1.01);
    filter: blur(0.45px);
  }
  100% {
    opacity: 0.55;
    transform: translate3d(0, 0, 0) scale(1.00);
    filter: blur(0.25px);
  }
}

@keyframes edge-flicker {
  0% {
    box-shadow:
      0 0 26px rgba(255, 200, 150, 0.55),
      0 0 55px rgba(255, 140, 90, 0.55),
      0 0 90px rgba(255, 100, 60, 0.45),
      0 26px 85px rgba(0, 0, 0, 0.95);
  }
  35% {
    box-shadow:
      0 0 34px rgba(255, 210, 160, 0.80),
      0 0 72px rgba(255, 150, 95, 0.70),
      0 0 120px rgba(255, 110, 70, 0.60),
      0 28px 95px rgba(0, 0, 0, 0.96);
  }
  65% {
    box-shadow:
      0 0 40px rgba(255, 190, 140, 0.65),
      0 0 82px rgba(255, 135, 88, 0.68),
      0 0 130px rgba(255, 105, 65, 0.52),
      0 30px 100px rgba(0, 0, 0, 0.97);
  }
  100% {
    box-shadow:
      0 0 32px rgba(255, 205, 155, 0.72),
      0 0 70px rgba(255, 145, 92, 0.68),
      0 0 115px rgba(255, 100, 60, 0.50),
      0 26px 90px rgba(0, 0, 0, 0.95);
  }
}


/* Prevent frog from shrinking and constrain speech bubble size */
#mode-squaredle .mascot-figure {
  flex-shrink: 0;
}

#mode-squaredle .mascot-speech {
  max-width: 240px;
  width: auto;
  flex-grow: 1;
  word-wrap: break-word;
}
</style>
</head>
<body>
  <div class="scene-overlay">
    <div class="fog-layer"></div>
    <div class="firefly f1"></div>
    <div class="firefly f2"></div>
    <div class="firefly f3"></div>
    <div class="firefly f4"></div>
    <div class="firefly f5"></div>
  </div>
  <div class="scene-glow"></div>

  <!-- GAME UI -->
  <div class="mode-switch">
    <button class="mode-button active" data-mode="squaredle">Squaredle</button>
    <button class="mode-button" data-mode="connections">Connections</button>
    <button class="mode-button" data-mode="fireflies">Wordle</button>
  </div>

  <div class="mode-panel-container">
    <div id="mode-squaredle" class="mode-panel active">
<div class="app-shell">
    <!-- LEFT: GRID + CONTROLS -->
    <div class="card">
      <div class="card-header">
        <div class="title">
          <div class="title-main">Squaredled Away</div>
          <div class="title-sub">Kyra's Birthday Edition</div>
        </div>
        <button id="resetBtn" class="control secondary">
          🔄 Reset Puzzle
        </button>
      </div>

      <div class="grid-wrapper">
        <div id="grid" class="grid"></div>

        <div class="hud">
          <div class="current-word">
            <span class="current-label">Current Path</span>
            <span id="currentWord" class="current-word-text">–</span>
          </div>
        </div>

        <div class="status-line">
          <span></span>
        </div>
      </div>
    </div>

    <!-- RIGHT: GOALS & WORDS -->
    <div class="card">
      <!-- Frog / toad mascot in kimono – illustrated images -->
      <div id="mascot" class="mascot mood-soft">
        <div class="mascot-figure">
          <img
            id="mascotImage"
            class="mascot-image"
            src="frog-neutral.png"
            alt="Frog spirit in a kimono"
          />
        </div>

        <div id="mascotSpeech" class="mascot-speech">
          Happy birthday, Kyra. The bathhouse is open, the spirit river is sparkling, and my break is definitely over. Let’s see which word-spirits step off the train. ✨
        </div>
      </div>

      <div class="goals-section">
        <div>
          <div class="section-title">Special Words</div>
          <div id="specialList" class="special-list"></div>
        </div>

        <div>
          <div class="section-title">Completion Goals</div>
          <div class="progress-group">
            <div class="progress-row">
              <span class="progress-label">4-letter words (excluding specials)</span>
              <span id="count4" class="progress-nums">0 / 10</span>
            </div>
            <div class="bar">
              <div id="bar4" class="bar-fill"></div>
            </div>

            <div class="progress-row">
              <span class="progress-label">5-letter words</span>
              <span id="count5" class="progress-nums">0 / 5</span>
            </div>
            <div class="bar">
              <div id="bar5" class="bar-fill"></div>
            </div>

            <div class="progress-row">
              <span class="progress-label">6+ letter words</span>
              <span id="count6" class="progress-nums">0 / 3</span>
            </div>
            <div class="bar">
              <div id="bar6" class="bar-fill"></div>
            </div>
          </div>
          <div class="status-line">
            <span>Welcome every special word to the bathhouse and meet these goals to complete tonight’s story. 🌙</span>
          </div>
        </div>

        <div class="words-section">
          <div class="section-title">Found Words</div>
          <div class="words-list">
            <div id="wordsInner" class="words-inner"></div>
          </div>
          <div class="status-line">
            <strong id="totalsLabel">0</strong>
            <span>word-spirits have shown themselves so far.</span>
          </div>
        </div>
      </div>
    </div>
  </div>
    </div> <!-- end mode-squaredle -->

    <div id="mode-connections" class="mode-panel">
      <div class="card connections-panel">
        <div class="card-header">
          <div class="title">
            <div class="title-main">Kiki&apos;s Connections</div>
            <div class="title-sub">Kyra&apos;s Birthday Edition</div>
          </div>
        </div>

        <div class="card-body connections-body">
          <div class="connections-main">
            <div class="connections-grid" id="connections-grid"></div>

            <div class="connections-hud">
              <button class="control" id="connections-submitBtn" type="button">
                ✔️ Submit
              </button>
              <button class="control secondary" id="connections-shuffleBtn" type="button">
                🔀 Shuffle Tiles
              </button>
            </div>

            <div class="connections-status-row">
              <div id="connections-statusMessage" class="connections-status-message subtle"></div>
              <div id="connections-strikesDisplay" class="connections-strikes">
                Attempts:
                <span class="connections-strike-dot"></span>
                <span class="connections-strike-dot"></span>
                <span class="connections-strike-dot"></span>
                <span class="connections-strike-dot"></span>
              </div>
            </div>

            <section id="connections-solvedGroups" class="connections-solved-groups"></section>
          </div>

          <section class="connections-side">
            <div id="connMascot" class="connections-mascot mood-soft">
              <div class="connections-mascot-figure">
                <div class="connections-mascot-image-wrap">
                  <img
                    id="connMascotImage"
                    class="connections-mascot-image"
                    src="mouse-neutral.png"
                    alt="Mouse mascot"
                  />
                </div>
              </div>
              <div class="connections-mascot-speech">
                <p id="connMascotSpeechText">
                  Let's see which words like to fly together...
                </p>
              </div>
            </div>

            <p class="connections-footer-note">
              Down in the rooftops below, tiny stories are hiding in groups of four.
              When you find a set that truly belongs together, their secret will be revealed.
            </p>
          </section>
        </div>
      </div>
    </div> <!-- end mode-connections -->

    <div id="mode-fireflies" class="mode-panel">
      <div class="app-shell fireflies-app">
        <div class="card fireflies-card">
          <div class="card-header fireflies-header">
            <div class="title">
              <div class="title-main">Wordle of the Fireflies</div>
              <div class="title-sub">Kyra&apos;s Birthday Edition</div>
            </div>
            <button id="firefliesResetBtn" class="control secondary" type="button">
              🔁 New Game
            </button>
          </div>

          <div class="fireflies-layout">
            <section class="fireflies-play">
              <div id="firefliesGrid" class="fireflies-grid"></div>
              <div id="firefliesKeyboard" class="fireflies-keyboard"></div>
              <div class="fireflies-status">
                <span id="firefliesStatus"></span>
              </div>
            </section>

            <aside class="fireflies-mascot-wrap">
              <div id="firefliesMascot" class="fireflies-mascot">
                <div class="fireflies-mascot-figure">
                  <img
                    id="firefliesMascotImage"
                    class="fireflies-mascot-image"
                    src="raccoon-neutral.png"
                    alt="Raccoon mascot"
                  />
                </div>
                <div class="fireflies-mascot-speech">
                  <p id="firefliesMascotSpeech">
                    Six chances, five letters. Let's chase a gentle little dream through the fireflies together.
                  </p>
                </div>
              </div>
            </aside>
          </div>
        </div>
      </div>
    </div> <!-- end mode-fireflies -->

  </div> <!-- end mode-panel-container -->


  <!-- Toast -->
  <div id="toast" class="toast">
    <span id="toastEmoji" class="toast-emoji">✨</span>
    <span id="toastText"></span>
  </div>

  <!-- Completion Overlay -->
  <div id="overlay" class="overlay">
    <div class="overlay-backdrop"></div>
    <div class="overlay-card">
      <div class="overlay-title">The night’s story is complete. 🎴</div>
      <div class="overlay-subtitle">
        Every special word has checked into the bathhouse, and your goals are fulfilled. The spirits bow in thanks.
      </div>
      <div class="hint-chip" style="justify-content:center; margin-bottom:8px;">
        <span>Keep wandering</span> · more gentle names still drift over the water.
      </div>
      <div id="overlayWords" class="overlay-words"></div>
      <div style="margin-top:18px;">
        <button id="closeOverlayBtn" class="control secondary">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Ambient music (loop) – put your own soft track here -->
  <audio id="ambientMusic" loop preload="auto">
    <source src="ambient.mp3" type="audio/mpeg" />
  </audio>
  <!-- Kiki's Connections ambient music -->
  <audio id="connectionsAmbient" loop preload="auto">
    <source src="KikisAudio.mp3" type="audio/mpeg" />
  </audio>
  <!-- Wordle of the Fireflies ambient music -->
  <audio id="firefliesAmbient" loop preload="auto">
    <source src="thefireflies.m4a" type="audio/mp4" />
  </audio>

  <!-- Pleasant chime when a special word is found -->
  <audio id="specialSound" preload="auto">
    <source src="special.mp3" type="audio/mpeg" />
  </audio>

  
  <script>
    // Mode switcher: Squaredle <-> Kiki's Connections <-> Wordle of the Fireflies
    (function () {
      const modeButtons = document.querySelectorAll('.mode-button');
      const modePanels = document.querySelectorAll('.mode-panel');
      const squaredleAmbient = document.getElementById('ambientMusic');
      const connectionsAmbient = document.getElementById('connectionsAmbient');
      const firefliesAmbient = document.getElementById('firefliesAmbient');

      modeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const mode = btn.dataset.mode; // "squaredle", "connections", or "fireflies"

          modeButtons.forEach(b => {
            b.classList.toggle('active', b === btn);
          });

          modePanels.forEach(panel => {
            panel.classList.toggle('active', panel.id === 'mode-' + mode);
          });

          if (mode === 'connections') {
            document.body.classList.add('connections-mode');
            document.body.classList.remove('fireflies-mode');

            if (typeof window.disableFirefliesBackground === "function") {
              window.disableFirefliesBackground();
            }

            // Switch to Kiki's audio
            if (squaredleAmbient) {
              try { squaredleAmbient.pause(); } catch (e) {}
            }
            if (firefliesAmbient) {
              try { firefliesAmbient.pause(); } catch (e) {}
            }
            if (connectionsAmbient) {
              try {
                connectionsAmbient.volume = 0.6;
                connectionsAmbient.currentTime = 0;
                connectionsAmbient.play().catch(() => {});
              } catch (e) {}
            }
          } else if (mode === 'fireflies') {
            document.body.classList.add('fireflies-mode');
            document.body.classList.remove('connections-mode');

            if (typeof window.enableFirefliesBackground === "function") {
              window.enableFirefliesBackground();
            }

            // Switch to Fireflies audio
            if (squaredleAmbient) {
              try { squaredleAmbient.pause(); } catch (e) {}
            }
            if (connectionsAmbient) {
              try { connectionsAmbient.pause(); } catch (e) {}
            }
            if (firefliesAmbient) {
              try {
                firefliesAmbient.volume = 0.4;
                firefliesAmbient.currentTime = 0;
                firefliesAmbient.play().catch(() => {});
              } catch (e) {}
            }
          } else {
            document.body.classList.remove('connections-mode');
            document.body.classList.remove('fireflies-mode');

            if (typeof window.disableFirefliesBackground === "function") {
              window.disableFirefliesBackground();
            }

            // Switch back to Squaredle audio
            if (connectionsAmbient) {
              try { connectionsAmbient.pause(); } catch (e) {}
            }
            if (firefliesAmbient) {
              try { firefliesAmbient.pause(); } catch (e) {}
            }
            if (squaredleAmbient) {
              try {
                squaredleAmbient.play().catch(() => {});
              } catch (e) {}
            }
          }
        });
      });
    })();;

    // Kiki's Connections game logic
    (function () {
      const categories = [
        {
          id: "blue",
          name: "Words/names that follow the names of your pets",
          colorClass: "category-blue",
          words: ["gallagher", "butter", "bobby brown", "lovegood"]
        },
        {
          id: "green",
          name: "Containing a shape/structure",
          colorClass: "category-green",
          words: ["squaredle", "biodome", "speed skating oval", "1 cubit"]
        },
        {
          id: "yellow",
          name: "Last ___",
          colorClass: "category-yellow",
          words: ["christmas", "straw", "resort", "laugh"]
        },
        {
          id: "purple",
          name: "Containing ways to soothing a baby",
          colorClass: "category-purple",
          words: ["raddler", "driving crooner", "jingle bell rock", "app for singles"]
        }
      ];

      const MAX_MISTAKES = 4;

      let tiles = [];
      let solvedCategoryIds = new Set();
      let selectedIndices = [];
      let mistakes = 0;
      let gameOver = false;

      const gridEl = document.getElementById("connections-grid");
      const statusMessageEl = document.getElementById("connections-statusMessage");
      const strikesDisplayEl = document.getElementById("connections-strikesDisplay");
      const solvedGroupsEl = document.getElementById("connections-solvedGroups");
      const shuffleBtn = document.getElementById("connections-shuffleBtn");
      const submitBtn = document.getElementById("connections-submitBtn");

      const ambientAudio = document.getElementById("connectionsAmbient") || null;
      const correctAudio = document.getElementById("specialSound") || null;

      // Mouse mascot
      const connMascot = document.getElementById("connMascot");
      const connMascotImage = document.getElementById("connMascotImage");
      const connMascotSpeechText = document.getElementById("connMascotSpeechText");

      const CONNECTIONS_MASCOT_IMAGES = {
        soft: ["mouse-neutral.png", "mouse-neutral2.png", "mouse-neutral3..png"],
        idea: ["mouse-idea.png", "mouse-idea2.png", "mouse-idea3.png"],
        excited: ["mouse-excited.png", "mouse-excited2.png"],
        explaining: ["mouse-explaining.png", "mouse-explaining2.png"],
        happy: ["mouse-happy.png", "mouse-happy2.png"]
      };

      const MASCOT_MOODS = ["soft", "idea", "excited", "explaining", "happy"];

      function setConnMascotMood(moodKey, message) {
        if (!connMascot || !connMascotImage) return;
        const mood = CONNECTIONS_MASCOT_IMAGES[moodKey] ? moodKey : "soft";
        const pool = CONNECTIONS_MASCOT_IMAGES[mood] || CONNECTIONS_MASCOT_IMAGES.soft;
        if (pool && pool.length) {
          const choice = pool[Math.floor(Math.random() * pool.length)];
          connMascotImage.src = choice;
        }

        MASCOT_MOODS.forEach(m => connMascot.classList.remove("mood-" + m));
        connMascot.classList.add("mood-" + mood);

        if (connMascotSpeechText && typeof message === "string") {
          connMascotSpeechText.textContent = message;
        }
      }

      let ambientStarted = false;

      function startAmbientAudioIfNeeded() {
        if (!ambientAudio || ambientStarted) return;
        ambientStarted = true;
        try {
          ambientAudio.play().catch(() => {});
        } catch (e) {}
      }

      function playCorrectSound() {
        if (!correctAudio) return;
        try {
          correctAudio.currentTime = 0;
          correctAudio.play().catch(() => {});
        } catch (e) {}
      }

      function shuffleArray(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      function buildTiles() {
        tiles = [];
        categories.forEach(cat => {
          cat.words.forEach(word => {
            tiles.push({
              word,
              categoryId: cat.id,
              solved: false
            });
          });
        });
        tiles = shuffleArray(tiles);
      }

      function renderGrid() {
        if (!gridEl) return;
        gridEl.innerHTML = "";
        tiles.forEach((tile, index) => {
          const div = document.createElement("div");
          div.className = "connections-tile";
          if (tile.solved) {
            div.classList.add("solved");
            div.classList.add("category-" + tile.categoryId);
          }
          if (selectedIndices.includes(index)) {
            div.classList.add("selected");
          }
          div.dataset.index = index;

          const span = document.createElement("span");
          span.textContent = tile.word.toUpperCase();
          div.appendChild(span);

          div.addEventListener("click", () => {
            if (gameOver) return;
            startAmbientAudioIfNeeded();
            handleTileClick(index);
          });

          gridEl.appendChild(div);
        });
      }

      function updateStrikesDisplay() {
        if (!strikesDisplayEl) return;
        const dots = strikesDisplayEl.querySelectorAll(".connections-strike-dot");
        dots.forEach((dot, i) => {
          dot.classList.toggle("used", i < mistakes);
        });
      }

      function setStatusMessage(text, type = "subtle") {
        if (!statusMessageEl) return;
        statusMessageEl.textContent = text;
        statusMessageEl.classList.remove("success", "error", "subtle");
        statusMessageEl.classList.add(type);
      }

      function updateSolvedGroupsDisplay() {
        if (!solvedGroupsEl) return;
        solvedGroupsEl.innerHTML = "";
        categories.forEach(cat => {
          if (!solvedCategoryIds.has(cat.id)) return;
          const row = document.createElement("div");
          const label = document.createElement("div");
          label.className = "connections-group-row-label";

          const pill = document.createElement("span");
          pill.className = "connections-group-pill " + cat.id;

          const labelText = document.createElement("span");
          labelText.textContent = cat.name;

          label.appendChild(pill);
          label.appendChild(labelText);
          row.appendChild(label);
          solvedGroupsEl.appendChild(row);
        });
      }

      function handleTileClick(index) {
        const tile = tiles[index];
        if (tile.solved) return;

        const existingIndex = selectedIndices.indexOf(index);
        if (existingIndex >= 0) {
          selectedIndices.splice(existingIndex, 1);
          renderGrid();
          return;
        }

        if (selectedIndices.length >= 4) {
          return; // do not allow more than 4 selected
        }

        selectedIndices.push(index);
        renderGrid();
      }

      function checkSelection() {
        if (selectedIndices.length !== 4) return;
        const selectedTiles = selectedIndices.map(i => tiles[i]);
        const categoryId = selectedTiles[0].categoryId;
        const allSameCategory = selectedTiles.every(t => t.categoryId === categoryId);
        const cat = categories.find(c => c.id === categoryId);

        if (allSameCategory && !solvedCategoryIds.has(categoryId)) {
          selectedIndices.forEach(i => {
            tiles[i].solved = true;
          });
          solvedCategoryIds.add(categoryId);
          playCorrectSound();
          setStatusMessage(cat ? `Nice! You found: ${cat.name}.` : "Nice! That group fits.", "success");
          const sampleWord = selectedTiles[Math.floor(Math.random() * selectedTiles.length)].word.toUpperCase();
          setConnMascotMood("excited", `Yes! "${sampleWord}" looks very pleased to be with its little family.`);
          reflowTiles();
          updateSolvedGroupsDisplay();
          selectedIndices = [];
          renderGrid();
          checkWin();
        } else {
          mistakes++;
          updateStrikesDisplay();

          const categoryCounts = {};
          selectedTiles.forEach(t => {
            categoryCounts[t.categoryId] = (categoryCounts[t.categoryId] || 0) + 1;
          });
          const maxCount = Math.max(...Object.values(categoryCounts));
          if (maxCount >= 3) {
            setStatusMessage("So close! At least three of those belong together.", "error");
            const museWord = selectedTiles[Math.floor(Math.random() * selectedTiles.length)].word.toUpperCase();
            setConnMascotMood("idea", `You're very close, but someone doesn't belong.`);
          } else {
            setStatusMessage("Not quite. Try a different combination.", "error");
            const museWord = selectedTiles[Math.floor(Math.random() * selectedTiles.length)].word.toUpperCase();
            setConnMascotMood("explaining", `Hmm... "${museWord}" doesn't feel at home. It may need more friends.`);
          }

          if (mistakes >= MAX_MISTAKES) {
            revealAll();
            gameOver = true;
            setStatusMessage("You’ve reached the attempt limit – all groups are revealed. 🌙", "error");
            setConnMascotMood("happy", "The mystery is revealed – nice work exploring!");
          }

          setTimeout(() => {
            selectedIndices = [];
            renderGrid();
          }, 400);
        }
      }

      function reflowTiles() {
        const solved = tiles.filter(t => t.solved);
        const unsolved = tiles.filter(t => !t.solved);
        tiles = [...solved, ...unsolved];
      }

      function checkWin() {
        if (solvedCategoryIds.size === categories.length) {
          gameOver = true;
          setStatusMessage("All four groups solved! Jiji is impressed. 🌟", "success");
          setConnMascotMood("happy", "You solved every group! Jiji would be proud.");
          triggerConnectionsWinMagic();
        }
      }


      function triggerConnectionsWinMagic() {
        const body = document.body;
        if (!body) return;

        body.classList.add("connections-gust-active");

        const layer = document.createElement("div");
        layer.className = "connections-petal-layer";
        document.body.appendChild(layer);

        const petalTotal = 42;

        for (let i = 0; i < petalTotal; i++) {
          const petal = document.createElement("div");
          const pathIndex = 1 + Math.floor(Math.random() * 3);
          petal.className = "petal path-" + pathIndex;

          const startBand = Math.random();
          const startX = -15 + startBand * 25; // from slightly off left into scene
          const startY = -10 - Math.random() * 30;

          petal.style.left = startX + "vw";
          petal.style.top = startY + "vh";

          const duration = 2600 + Math.random() * 1400;
          const delay = Math.random() * 900;

          petal.style.animationDuration = duration + "ms";
          petal.style.animationDelay = delay + "ms";

          layer.appendChild(petal);
        }

        setTimeout(() => {
          body.classList.remove("connections-gust-active");
          layer.remove();
        }, 4600);
      }

      function revealAll() {
        tiles.forEach(t => {
          t.solved = true;
          solvedCategoryIds.add(t.categoryId);
        });
        reflowTiles();
        updateSolvedGroupsDisplay();
        renderGrid();
      }

      function resetGame() {
        gameOver = false;
        mistakes = 0;
        solvedCategoryIds.clear();
        selectedIndices = [];
        buildTiles();
        updateStrikesDisplay();
        updateSolvedGroupsDisplay();
        setStatusMessage("", "subtle");
        setConnMascotMood("soft", "Fresh tiles, fresh breeze.");
        renderGrid();
      }

      function shuffleUnsolvedTiles() {
        if (gameOver) return;
        const solved = tiles.filter(t => t.solved);
        const unsolved = tiles.filter(t => !t.solved);
        const shuffled = shuffleArray(unsolved);
        tiles = [...solved, ...shuffled];
        selectedIndices = [];
        renderGrid();
        setStatusMessage("Tiles shuffled.", "subtle");
        setConnMascotMood("soft", "Let’s see if a new view helps.");
      }

      if (shuffleBtn) {
        shuffleBtn.addEventListener("click", () => {
          startAmbientAudioIfNeeded();
          shuffleUnsolvedTiles();
        });
      }

      if (submitBtn) {
        submitBtn.addEventListener("click", () => {
          startAmbientAudioIfNeeded();
          if (selectedIndices.length === 4) {
            checkSelection();
          } else {
            setStatusMessage("Select four tiles before submitting.", "error");
            setConnMascotMood("idea", "Try choosing four tiles that feel related.");
          }
        });
      }

      // Initialize once
      
      if (connMascot) {
        connMascot.style.cursor = "pointer";
        connMascot.addEventListener("click", () => {
          const messages = [
            "Don't get all bent out of shape! Keep looking!",
            "Ok... I'll give you one last hint!",
            "I wonder what my friends are up to?",
            "Four legs good. Two legs bad."
          ];
          const msg = messages[Math.floor(Math.random() * messages.length)];
          setConnMascotMood("idea", msg);
        });
      }

if (gridEl) {
        buildTiles();
        renderGrid();
        updateStrikesDisplay();
        setStatusMessage("", "subtle");
        setConnMascotMood("soft", "Let’s find some cozy little groups...");
      }
    })();
  </script>


<script>
    // --- Game config ---
    const GRID = [
      ["g", "",  "s", "y", "o", "u", ""],
      ["i", "m", "a", "e", "",  "e", "m"],
      ["m", "m", "e", "t", "v", "o", "r"],
      ["i", "u", "p", "o", "h", "i", ""],
      ["o", "s", "i", "a", "l", "n", "p"],
      ["",  "m", "n", "m", "t", "o", "d"],
      ["",  "i", "d", "n", "o", "p", ""]
    ];

    const SPECIAL_WORDS = [
      "minimoon",
      "pondpond",
      "iloveyoumore",
      "gimmethat",
      "sammisoupe"
    ];

    const GOALS = {
      four: 10,
      five: 5,
      sixPlus: 3
    };

    const SPECIAL_SET = new Set(SPECIAL_WORDS.map(w => w.toLowerCase()));
    const WORD_VALIDITY_CACHE = new Map();

    async function isEnglishWord(word) {
      const w = word.toLowerCase();
      if (SPECIAL_SET.has(w)) return true;

      if (WORD_VALIDITY_CACHE.has(w)) {
        return WORD_VALIDITY_CACHE.get(w);
      }

      try {
        const response = await fetch(
          `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(w)}`
        );

        if (!response.ok) {
          WORD_VALIDITY_CACHE.set(w, false);
          return false;
        }

        const data = await response.json();
        const valid = Array.isArray(data) && data.length > 0;
        WORD_VALIDITY_CACHE.set(w, valid);
        return valid;
      } catch (e) {
        WORD_VALIDITY_CACHE.set(w, false);
        return false;
      }
    }


    const MASCOT_IMAGES = {
      // Base / idle
      soft: "frog-neutral.png",
      neutral: "frog-neutral.png",

      // “Something went wrong” / thinking states
      shy: "frog-reflecting.png",
      reflecting: "frog-reflecting.png",
      thinking: "frog-thinking.png",
      pondering: "frog-pondering.png",

      // Normal successful word (non-special)
      mischief: "frog-running.png",
      running: "frog-running.png",
      pleased: "frog-pleased.png",

      // Special word celebration
      excited: "frog-excited.png",
      jumping: "frog-jumping.png",
      celebrating: "frog-celebrating.png",

      // Hint-giving pose
      idea: "frog-idea.png"
    };

    // --- State ---
    const state = {
      path: [],
      foundWords: [],
      foundSet: new Set(),
      specialFound: new Set(),
      dragging: false,
      allSpecialCelebrated: false,
      goalsCelebrated: false
    };

    // --- DOM refs ---
    const gridEl = document.getElementById("grid");
    const currentWordEl = document.getElementById("currentWord");
    const specialListEl = document.getElementById("specialList");
    const wordsInnerEl = document.getElementById("wordsInner");
    const totalsLabelEl = document.getElementById("totalsLabel");
    const toastEl = document.getElementById("toast");
    const toastEmojiEl = document.getElementById("toastEmoji");
    const toastTextEl = document.getElementById("toastText");
    const bar4El = document.getElementById("bar4");
    const bar5El = document.getElementById("bar5");
    const bar6El = document.getElementById("bar6");
    const count4El = document.getElementById("count4");
    const count5El = document.getElementById("count5");
    const count6El = document.getElementById("count6");
    const overlayEl = document.getElementById("overlay");
    const overlayWordsEl = document.getElementById("overlayWords");
    const closeOverlayBtn = document.getElementById("closeOverlayBtn");
    const resetBtn = document.getElementById("resetBtn");
    const mascotEl = document.getElementById("mascot");
    const mascotSpeechEl = document.getElementById("mascotSpeech");
    const mascotImageEl = document.getElementById("mascotImage");
    const ambientMusicEl = document.getElementById("ambientMusic");
    const specialSoundEl = document.getElementById("specialSound");

    let ambientStarted = false;
    let mascotMood = "soft";

    function startAmbientMusic() {
      if (!ambientMusicEl || ambientStarted) return;
      try {
        ambientMusicEl.volume = 0;
        const playPromise = ambientMusicEl.play();
        if (playPromise && typeof playPromise.then === "function") {
          playPromise.then(() => {
            ambientStarted = true;
            let v = 0;
            const step = () => {
              v += 0.02;
              ambientMusicEl.volume = Math.min(1.0, v);
              if (v < 1.0) {
                requestAnimationFrame(step);
              }
            };
            requestAnimationFrame(step);
          }).catch(() => {});
        } else {
          ambientStarted = true;
          ambientMusicEl.volume = 1.0;
        }
      } catch (e) {}
    }

    // --- Helpers ---
    function isAdjacent(a, b) {
      const dr = Math.abs(a.row - b.row);
      const dc = Math.abs(a.col - b.col);
      return (dr <= 1 && dc <= 1 && (dr + dc) > 0);
    }

    function getCurrentWord() {
      return state.path.map(p => p.letter).join("");
    }

    function updateCurrentWordDisplay() {
      const word = getCurrentWord();
      currentWordEl.textContent = word || "–";
    }

    function clearPath() {
      state.path.forEach(p => {
        p.tileEl.classList.remove("selected");
        const idxEl = p.tileEl.querySelector(".tile-index");
        if (idxEl) {
          idxEl.textContent = "";
        }
      });
      state.path = [];
      updateCurrentWordDisplay();
    }

    function showToast(message, { good = true, emoji = "✨" } = {}) {
      toastEl.classList.remove("good", "bad");
      toastEl.classList.add(good ? "good" : "bad");
      toastEmojiEl.textContent = emoji;
      toastTextEl.textContent = message;

      toastEl.classList.add("show");
      setTimeout(() => {
        toastEl.classList.remove("show");
      }, 1800);
    }

    function setMascotMessage(message) {
      if (!mascotSpeechEl) return;
      mascotSpeechEl.textContent = message;
    }

    function setMascotMood(mood) {
      if (!mascotEl) return;
      mascotMood = mood;

      mascotEl.classList.remove("mood-soft", "mood-shy", "mood-mischief", "mood-excited");

      // Decide which image key to use from MASCOT_IMAGES
      let imageKey = "neutral";

      if (mood === "shy") {
        // Mistake / too-short / duplicate word
        mascotEl.classList.add("mood-shy");
        // Randomly pick between reflecting, thinking, and pondering
        const options = ["reflecting", "thinking", "pondering"];
        imageKey = options[Math.floor(Math.random() * options.length)];
      } else if (mood === "mischief") {
        // Normal non-special word success
        mascotEl.classList.add("mood-mischief");
        // Alternate between running and pleased sprites
        const options = ["running", "pleased"];
        imageKey = options[Math.floor(Math.random() * options.length)];
      } else if (mood === "excited") {
        // Special words only
        mascotEl.classList.add("mood-excited");
        // Choose among excited, jumping, and celebrating sprites
        const options = ["excited", "jumping", "celebrating"];
        imageKey = options[Math.floor(Math.random() * options.length)];
      } else if (mood === "idea") {
        // Hint pose when the player asks for help
        mascotEl.classList.add("mood-mischief");
        imageKey = "idea";
      } else {
        // Default soft / neutral
        mascotEl.classList.add("mood-soft");
        imageKey = "neutral";
      }

      const src = MASCOT_IMAGES[imageKey] || MASCOT_IMAGES.neutral;
      if (mascotImageEl && src) {
        mascotImageEl.src = src;
      }
    }

    
    function giveHint() {
      // Make sure the ambient music is allowed to start from this interaction
      startAmbientMusic();

      // Figure out which special words are still missing
      const remainingSpecials = SPECIAL_WORDS.filter(
        w => !state.specialFound.has(w.toLowerCase())
      );

      let message;

      if (remainingSpecials.length === 0) {
        // All special words already found
        message = "Every special guest you were meant to find is already here. At this point I'm just here for the snacks. 🌙";
      } else {
        const choice = remainingSpecials[Math.floor(Math.random() * remainingSpecials.length)];
        const firstTwo = choice.slice(0, 2).toUpperCase();
        const firstThree = choice.slice(0, 3).toUpperCase();
        const length = choice.length;

        message = `Okay, tiny spoiler: this special word begins with “${firstThree}” and is ${length} letters long. See if you can wiggle a path that fits it. 💡`;
      }

      setMascotMood("idea"); // uses frog-idea.png via MASCOT_IMAGES
      setMascotMessage(message);
      showToast("The frog whispers a suspiciously helpful hint.", { good: true, emoji: "💡" });
    }

function triggerMascotDance() {
      if (!mascotEl) return;
      mascotEl.classList.add("dancing");
      setTimeout(() => {
        mascotEl.classList.remove("dancing");
      }, 1800);
    }
    function triggerGridSparkle() {
      if (!gridEl) return;
      const wrapper = gridEl.closest(".grid-wrapper") || gridEl.parentElement;
      if (!wrapper) return;
      wrapper.classList.remove("grid-sparkle");
      // force reflow so animation can restart
      void wrapper.offsetWidth;
      wrapper.classList.add("grid-sparkle");
      setTimeout(() => {
        wrapper.classList.remove("grid-sparkle");
      }, 950);
    }


    function updateSpecialListUI() {
      specialListEl.innerHTML = "";
      SPECIAL_WORDS.forEach(w => {
        const lower = w.toLowerCase();
        const found = state.specialFound.has(lower);

        const row = document.createElement("div");
        row.className = "special-item";

        const left = document.createElement("div");
        left.className = "special-left";

        const circle = document.createElement("div");
        circle.className = "check-circle" + (found ? " filled" : "");
        circle.textContent = found ? "✓" : "";

        const wordLabel = document.createElement("div");
        wordLabel.className = "special-word-label";

        const displayLabel = found ? w : "•".repeat(w.length);
        wordLabel.textContent = displayLabel;

        left.appendChild(circle);
        left.appendChild(wordLabel);

        const badge = document.createElement("div");
        badge.className = "badge " + (found ? "found" : "missing");
        badge.textContent = found ? "Found" : "Hidden";

        row.appendChild(left);
        row.appendChild(badge);

        specialListEl.appendChild(row);
      });
    }

    function updateWordsUI() {
      wordsInnerEl.innerHTML = "";
      state.foundWords.forEach(({ word, isSpecial }) => {
        const chip = document.createElement("div");
        chip.className = "word-chip" + (isSpecial ? " special" : "");
        chip.textContent = word;
        const meta = document.createElement("span");
        meta.textContent = isSpecial ? "★" : `${word.length}`;
        chip.appendChild(meta);
        wordsInnerEl.appendChild(chip);
      });
      totalsLabelEl.textContent = state.foundWords.length.toString();
    }

    function updateGoalProgressUI() {
      let count4 = 0;
      let count5 = 0;
      let count6 = 0;

      state.foundWords.forEach(({ word, isSpecial }) => {
        if (isSpecial) return;
        const len = word.length;
        if (len === 4) count4++;
        else if (len === 5) count5++;
        else if (len >= 6) count6++;
      });

      const p4 = Math.min(1, count4 / GOALS.four);
      const p5 = Math.min(1, count5 / GOALS.five);
      const p6 = Math.min(1, count6 / GOALS.sixPlus);

      bar4El.style.width = (p4 * 100).toFixed(0) + "%";
      bar5El.style.width = (p5 * 100).toFixed(0) + "%";
      bar6El.style.width = (p6 * 100).toFixed(0) + "%";

      count4El.textContent = `${count4} / ${GOALS.four}`;
      count5El.textContent = `${count5} / ${GOALS.five}`;
      count6El.textContent = `${count6} / ${GOALS.sixPlus}`;

      checkForCompletion(count4, count5, count6);
    }

    
    function triggerLastSpecialEffects() {
      const body = document.body;
      if (!body || state.allSpecialCelebrated) return;
      state.allSpecialCelebrated = true;

      body.classList.add("last-special-burst");
      showToast("All special words have arrived at the bathhouse.", { good: true, emoji: "🏮" });
      setMascotMood("soft");
      setMascotMessage("Every honored guest is here now. The frog council officially approves this party. ✨");
      setTimeout(() => {
        body.classList.remove("last-special-burst");
      }, 1300);
    }

    function triggerGoalsMetEffects() {
      const body = document.body;
      if (!body || state.goalsCelebrated) return;
      state.goalsCelebrated = true;

      body.classList.add("goals-aura");
      showToast("All word goals are glowing softly. 🌙", { good: true, emoji: "🌙" });
      setMascotMood("soft");
      setMascotMessage("The goals are all softly shining now. If every special guest is here too, we can finally clock out. 🏮");
      setTimeout(() => {
        body.classList.remove("goals-aura");
      }, 1700);
    }
function checkForCompletion(c4, c5, c6) {
      const allSpecialFound = SPECIAL_WORDS.every(w =>
        state.specialFound.has(w.toLowerCase())
      );
      const goalsMet =
        c4 >= GOALS.four &&
        c5 >= GOALS.five &&
        c6 >= GOALS.sixPlus;

      if (goalsMet && !state.goalsCelebrated) {
        triggerGoalsMetEffects();
      }

      if (allSpecialFound && goalsMet) {
        showCompletionOverlay();
      }
    }

    function showCompletionOverlay() {
      overlayWordsEl.innerHTML = "";
      SPECIAL_WORDS.forEach(w => {
        const chip = document.createElement("div");
        chip.className = "word-chip special";
        chip.textContent = w;
        overlayWordsEl.appendChild(chip);
      });

      for (let i = 0; i < 24; i++) {
        const conf = document.createElement("div");
        conf.className = "confetti";
        const offset = (Math.random() * 280 - 140).toFixed(0) + "px";
        const delay = (Math.random() * 0.5).toFixed(2) + "s";
        conf.style.setProperty("--x-offset", offset);
        conf.style.left = (50 + (Math.random() * 40 - 20)) + "%";
        conf.style.animationDelay = delay;
        overlayEl.appendChild(conf);
        setTimeout(() => {
          conf.remove();
        }, 1100);
      }

      overlayEl.classList.add("show");
      triggerHeartBloomEffect();
      setMascotMood("soft");
      setMascotMessage("We did it, Kyra. All the special words have checked in for the night. The windows are glowing for you. 🏮");
      triggerMascotDance();
    }

    
    function triggerHeartBloomEffect() {
      const body = document.body;
      if (!body) return;

      // Add class for core + halo glow
      body.classList.add("heart-bloom-active");

      // Create ember layer
      const layer = document.createElement("div");
      layer.className = "heart-ember-layer";
      document.body.appendChild(layer);

      const emberCount = 26;
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;

      for (let i = 0; i < emberCount; i++) {
        const ember = document.createElement("div");
        ember.className = "heart-ember";

        const angle = (Math.PI * 2 * i / emberCount) + (Math.random() * 0.7 - 0.35);
        const radius = 40 + Math.random() * 120;

        const startX = centerX + Math.cos(angle) * radius;
        const startY = centerY + Math.sin(angle) * radius;

        ember.style.left = startX + "px";
        ember.style.top = startY + "px";

        const duration = 2600 + Math.random() * 900;
        const delay = Math.random() * 400;

        ember.style.animationDuration = duration + "ms";
        ember.style.animationDelay = delay + "ms";

        ember.style.animationName = "heart-ember-rise";

        layer.appendChild(ember);

        setTimeout(() => {
          ember.remove();
        }, duration + delay + 200);
      }

      // Cleanup class + layer after animation
      setTimeout(() => {
        body.classList.remove("heart-bloom-active");
        layer.remove();
      }, 4200);
    }

function hideCompletionOverlay() {
      overlayEl.classList.remove("show");
    }

    async function handleSubmitWord() {
      const word = getCurrentWord().toLowerCase();
      const prettyWord = word.toUpperCase();

      if (!word || word.length < 4) {
        showToast("That word is a little too shy. Try at least four letters.", { good: false, emoji: "⚠️" });
        clearPath();
        setMascotMood("shy");
        setMascotMessage(`"${prettyWord}" is a bit short for the spirit railway—let's try at least four letters. 🌬️`);
        return;
      }

      if (state.foundSet.has(word)) {
        showToast("We’ve already greeted that spirit.", { good: false, emoji: "🔁" });
        clearPath();
        setMascotMood("shy");
        setMascotMessage(`"${prettyWord}" is already in our guestbook. The frog union demands fresh material. ✨`);
        return;
      }

      const isSpecial = SPECIAL_SET.has(word);

      // For non-special words, check against an English dictionary API
      if (!isSpecial) {
        const isValid = await isEnglishWord(word);
        if (!isValid) {
          showToast("The spirits don’t recognize that as a real English word.", { good: false, emoji: "📚" });
          clearPath();
          setMascotMood("shy");
          setMascotMessage(`The bathhouse spirits blink at "${prettyWord}". Let's stick to words they actually know. 🌙`);
          return;
        }
      }

      state.foundSet.add(word);
      state.foundWords.push({ word, isSpecial });

      if (isSpecial) {
        state.specialFound.add(word);

        if (state.specialFound.size === SPECIAL_WORDS.length && !state.allSpecialCelebrated) {
          triggerLastSpecialEffects();
        }

showToast("A special word arrives at the bathhouse!", { good: true, emoji: "🌟" });

        if (specialSoundEl) {
          try {
            specialSoundEl.currentTime = 0;
            specialSoundEl.volume = 0.9;
            specialSoundEl.play();
          } catch (e) {}
        }

        setMascotMood("excited");
        setMascotMessage(`Look! "${prettyWord}" sparkles differently—an honoured guest has stepped off the train. 💫`);
        triggerMascotDance();
        triggerGridSparkle();
      } else {
        if (word.length >= 6) {
          showToast("A long, graceful name.", { good: true, emoji: "💫" });
          setMascotMood("soft");
          setMascotMessage(`What a beautiful, winding word—"${prettyWord}" feels like the train gliding over the water. 🚂`);
        } else {
          showToast("A new word spirit appears.", { good: true, emoji: "✨" });
          setMascotMood("mischief");
          setMascotMessage(`Nice find! "${prettyWord}" joins the quiet little names hiding between the tiles. 🌌`);
        }
      }

      updateSpecialListUI();
      updateWordsUI();
      updateGoalProgressUI();
      clearPath();
    }

    function createGrid() {
      gridEl.innerHTML = "";
      for (let r = 0; r < GRID.length; r++) {
        for (let c = 0; c < GRID[r].length; c++) {
          const letter = GRID[r][c];
          const tile = document.createElement("button");
          tile.className = "tile";
          tile.dataset.row = String(r);
          tile.dataset.col = String(c);

          if (!letter) {
            tile.classList.add("blank");
            tile.disabled = true;
          } else {
            tile.textContent = letter.toUpperCase();
            const idx = document.createElement("div");
            idx.className = "tile-index";
            tile.appendChild(idx);
          }

          gridEl.appendChild(tile);
        }
      }
    }

    function updatePathOrderLabels() {
      const tiles = gridEl.querySelectorAll(".tile");
      tiles.forEach(t => {
        const idx = t.querySelector(".tile-index");
        if (idx) idx.textContent = "";
      });

      state.path.forEach((p, i) => {
        const idx = p.tileEl.querySelector(".tile-index");
        if (idx) idx.textContent = String(i + 1);
      });
    }

    // Allow deselecting cells by backtracking with the cursor
    function addTileToPath(tile) {
      const row = parseInt(tile.dataset.row, 10);
      const col = parseInt(tile.dataset.col, 10);
      const letter = GRID[row][col];

      if (!letter) return;

      const existingIndex = state.path.findIndex(p => p.row === row && p.col === col);

      if (existingIndex !== -1) {
        const lastIndex = state.path.length - 1;

        if (existingIndex === lastIndex) {
          const last = state.path.pop();
          last.tileEl.classList.remove("selected");
          const idxEl = last.tileEl.querySelector(".tile-index");
          if (idxEl) idxEl.textContent = "";
          updatePathOrderLabels();
          updateCurrentWordDisplay();
          return;
        }

        if (state.dragging && existingIndex === lastIndex - 1) {
          const removed = state.path.pop();
          removed.tileEl.classList.remove("selected");
          const idxEl = removed.tileEl.querySelector(".tile-index");
          if (idxEl) idxEl.textContent = "";
          updatePathOrderLabels();
          updateCurrentWordDisplay();
        }

        return;
      }

      const newStep = { row, col, letter, tileEl: tile };
      if (state.path.length > 0) {
        const last = state.path[state.path.length - 1];
        if (!isAdjacent(last, newStep)) {
          return;
        }
      }

      state.path.push(newStep);
      tile.classList.add("selected");
      updatePathOrderLabels();
      updateCurrentWordDisplay();
    }

    function setupInteractions() {
      const tiles = Array.from(gridEl.querySelectorAll(".tile")).filter(t => !t.classList.contains("blank"));

      tiles.forEach(tile => {
        tile.addEventListener("mousedown", e => {
          e.preventDefault();
          startAmbientMusic();
          state.dragging = true;
          clearPath();
          addTileToPath(tile);
        });

        tile.addEventListener("mouseenter", () => {
          if (state.dragging) {
            addTileToPath(tile);
          }
        });

        tile.addEventListener("click", () => {
          if (!state.dragging) {
            startAmbientMusic();
            addTileToPath(tile);
          }
        });
      });

      document.addEventListener("mouseup", () => {
        if (state.dragging) {
          state.dragging = false;
          if (state.path.length) {
            handleSubmitWord();
          }
        } else {
          state.dragging = false;
        }
      });

      document.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          handleSubmitWord();
        } else if (e.key === "Escape") {
          clearPath();
          setMascotMood("soft");
          setMascotMessage("No rush. Take a breath, then choose a new path along the tracks. 🕯️");
        } else if (!ambientStarted) {
          startAmbientMusic();
        }
      });

      closeOverlayBtn.addEventListener("click", hideCompletionOverlay);
      overlayEl.addEventListener("click", e => {
        if (e.target === overlayEl) hideCompletionOverlay();
      });

      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          startAmbientMusic();
          resetGame();
        });
      }

      // Click the frog to request a hint
      if (mascotEl) {
        mascotEl.style.cursor = "pointer";
        mascotEl.addEventListener("click", () => {
          giveHint();
        });
      }
    }

    function resetGame() {
      clearPath();
      state.foundWords = [];
      state.foundSet = new Set();
      state.specialFound = new Set();

      const tiles = gridEl.querySelectorAll(".tile");
      tiles.forEach(t => {
        t.classList.remove("selected");
        const idx = t.querySelector(".tile-index");
        if (idx) idx.textContent = "";
      });

      hideCompletionOverlay();
      updateSpecialListUI();
      updateWordsUI();
      updateGoalProgressUI();
      setMascotMood("soft");
      setMascotMessage("The guestbook has been gently wiped clean. New word-spirits will arrive soon. 🌌");
      showToast("Puzzle reset. The night begins anew.", { good: true, emoji: "🔄" });
    }

    
    // Background fireflies helpers for Wordle of the Fireflies
    window.enableFirefliesBackground = function () {
      if (document.querySelector(".fireflies-background-layer")) return;
      const layer = document.createElement("div");
      layer.className = "fireflies-background-layer";

      const count = 26;
      for (let i = 0; i < count; i++) {
        const firefly = document.createElement("div");
        firefly.className = "firefly-bg";

        const left = Math.random() * 100;
        const top = Math.random() * 100;
        const duration = 8000 + Math.random() * 6000;
        const delay = Math.random() * 6000;

        firefly.style.left = left + "%";
        firefly.style.top = top + "%";
        firefly.style.animationDuration = duration + "ms";
        firefly.style.animationDelay = delay + "ms";

        layer.appendChild(firefly);
      }

      document.body.appendChild(layer);
    };

    window.disableFirefliesBackground = function () {
      const layer = document.querySelector(".fireflies-background-layer");
      if (layer) layer.remove();
    };

    function triggerFireflyWinSwarm() {
      const existing = document.querySelector(".fireflies-swarm-layer");
      if (existing) existing.remove();

      const layer = document.createElement("div");
      layer.className = "fireflies-swarm-layer";
      document.body.appendChild(layer);

      const width = window.innerWidth;
      const height = window.innerHeight;
      const total = 72;

      for (let i = 0; i < total; i++) {
        const dot = document.createElement("div");
        dot.className = "firefly-swarm";

        const pathIdx = 1 + Math.floor(Math.random() * 3);
        if (pathIdx === 1) {
          dot.classList.add("swirl-a");
        } else if (pathIdx === 2) {
          dot.classList.add("swirl-b");
        } else {
          dot.classList.add("swirl-c");
        }

        const startX = (0.2 + Math.random() * 0.6) * width;
        const startY = (0.55 + Math.random() * 0.25) * height;

        dot.style.left = startX + "px";
        dot.style.top = startY + "px";

        const duration = 2400 + Math.random() * 1600;
        const delay = Math.random() * 900;

        dot.style.animationDuration = duration + "ms";
        dot.style.animationDelay = delay + "ms";

        layer.appendChild(dot);
      }

      setTimeout(() => {
        layer.remove();
      }, 4600);
    }

    // Wordle of the Fireflies logic
    (function () {
      const WORD_LENGTH = 5;
      const MAX_GUESSES = 6;
      const SECRET_WORD = "DREAM";
      const BUILTIN_VALID_GUESSES = [
        "dream","heart","light","night","stars","smile","grace","peace","bread","tears",
        "fires","river","shine","sweet","cloud","bloom","trace","flame","brave","stone",
        "sound","story","magic","faith","laugh","dance","spark","glow","quiet","child",
        "angel","candy","honey","crown","field","amber","cabin","candle","charm","fairy",
        "flock","flora","gazer","gleam","grace","grove","harp","haven","joyful","lilac",
        "lunar","meadow","mirth","mossy","ocean","petal","piano","pivot","poppy","river",
        "robin","roses","shine","silky","siren","skies","songy","spark","spoon","story",
        "tasty","treat","twirl","velvet","whirl","whisp","winds","wispy","world","young"
      ];

      // If you want a full English word list, you can define window.WORDLE_DICTIONARY = [ "about", "other", ... ]
      // in a separate script before this one. Those words will replace the built-in list.
      const VALID_GUESSES = new Set(
        (window.WORDLE_DICTIONARY && Array.isArray(window.WORDLE_DICTIONARY)
          ? window.WORDLE_DICTIONARY
          : BUILTIN_VALID_GUESSES
        ).map(w => w.toLowerCase())
      );

      const gridEl = document.getElementById("firefliesGrid");
      const keyboardEl = document.getElementById("firefliesKeyboard");
      const statusEl = document.getElementById("firefliesStatus");
      const mascotImg = document.getElementById("firefliesMascotImage");
      const mascotSpeech = document.getElementById("firefliesMascotSpeech");
      const resetBtn = document.getElementById("firefliesResetBtn");
      const wordlePanel = document.getElementById("mode-fireflies");

      if (!gridEl || !keyboardEl || !statusEl || !mascotImg || !mascotSpeech || !resetBtn || !wordlePanel) {
        return;
      }

      let currentRow = 0;
      let currentCol = 0;
      let isGameOver = false;
      const guesses = Array.from({ length: MAX_GUESSES }, () => Array(WORD_LENGTH).fill(""));

      function isActivePanel() {
        return wordlePanel.classList.contains("active");
      }

      function setMascot(state, text) {
        const map = {
          neutral: "raccoon-neutral.png",
          unsure: "raccoon-unsure.png",
          concerned: "raccoon-concerned.png",
          sweet: "raccoon-sweet.png",
          covering: "raccoon-covering_eyes.png",
          celebrating: "raccoon-celebrating.png",
          victorious: "raccoon-victorious.png"
        };
        if (map[state]) {
          mascotImg.src = map[state];
        }
        if (text) {
          mascotSpeech.textContent = text;
        }
      }

      function buildGrid() {
        gridEl.innerHTML = "";
        for (let row = 0; row < MAX_GUESSES; row++) {
          const rowEl = document.createElement("div");
          rowEl.className = "fireflies-row";
          for (let col = 0; col < WORD_LENGTH; col++) {
            const tile = document.createElement("div");
            tile.className = "fireflies-tile";
            tile.dataset.row = String(row);
            tile.dataset.col = String(col);
            rowEl.appendChild(tile);
          }
          gridEl.appendChild(rowEl);
        }
      }

      const KEY_ROWS = ["QWERTYUIOP", "ASDFGHJKL", "ZXCVBNM"];

      function buildKeyboard() {
        keyboardEl.innerHTML = "";
        KEY_ROWS.forEach((row, idx) => {
          const rowEl = document.createElement("div");
          rowEl.className = "fireflies-keyboard-row";

          if (idx === 2) {
            const enterKey = document.createElement("button");
            enterKey.type = "button";
            enterKey.className = "fireflies-key wide";
            enterKey.dataset.key = "ENTER";
            enterKey.textContent = "Enter";
            rowEl.appendChild(enterKey);
          }

          for (const ch of row) {
            const key = document.createElement("button");
            key.type = "button";
            key.className = "fireflies-key";
            key.dataset.key = ch;
            key.textContent = ch;
            rowEl.appendChild(key);
          }

          if (idx === 2) {
            const backKey = document.createElement("button");
            backKey.type = "button";
            backKey.className = "fireflies-key wide";
            backKey.dataset.key = "BACKSPACE";
            backKey.textContent = "⌫";
            rowEl.appendChild(backKey);
          }

          keyboardEl.appendChild(rowEl);
        });

        keyboardEl.addEventListener("click", (e) => {
          const btn = e.target.closest(".fireflies-key");
          if (!btn) return;
          handleKey(btn.dataset.key);
        });
      }

      function updateGrid() {
        for (let row = 0; row < MAX_GUESSES; row++) {
          for (let col = 0; col < WORD_LENGTH; col++) {
            const tile = gridEl.querySelector(`.fireflies-tile[data-row="${row}"][data-col="${col}"]`);
            if (!tile) continue;
            const ch = guesses[row][col];
            tile.textContent = ch ? ch.toUpperCase() : "";
          }
        }
      }

      function setStatus(msg) {
        statusEl.textContent = msg || "";
      }

      function handleKey(key) {
        if (!isActivePanel()) return;
        if (isGameOver) return;

        if (key === "ENTER") {
          onSubmitGuess();
          return;
        }
        if (key === "BACKSPACE") {
          onDeleteLetter();
          return;
        }

        if (key && key.length === 1 && key.match(/[A-Z]/)) {
          onAddLetter(key.toLowerCase());
        }
      }

      function onAddLetter(ch) {
        if (currentCol >= WORD_LENGTH || currentRow >= MAX_GUESSES) return;
        guesses[currentRow][currentCol] = ch;
        currentCol++;
        updateGrid();
        const tile = gridEl.querySelector(`.fireflies-tile[data-row="${currentRow}"][data-col="${currentCol - 1}"]`);
        if (tile) tile.classList.add("pop");
        setTimeout(() => tile && tile.classList.remove("pop"), 160);
      }

      function onDeleteLetter() {
        if (currentCol === 0) return;
        currentCol--;
        guesses[currentRow][currentCol] = "";
        updateGrid();
      }

      function onSubmitGuess() {
        if (currentCol < WORD_LENGTH) {
          setStatus("Not enough letters.");
          setMascot("covering", "Almost... but dreams need five letters here. I'm cheering for every letter you place.");
          return;
        }

        const guess = guesses[currentRow].join("").toLowerCase();
        const prettyGuess = guess.toUpperCase();

        if (!VALID_GUESSES.has(guess)) {
          setStatus("Not in word list.");
          setMascot("covering", `I don't recognize "${prettyGuess}", but I love that you're trying new words.`);
          return;
        }

        const solution = SECRET_WORD.toLowerCase();
        const solutionLetters = solution.split("");
        const result = Array(WORD_LENGTH).fill("absent");
        const letterCounts = {};

        for (const ch of solutionLetters) {
          letterCounts[ch] = (letterCounts[ch] || 0) + 1;
        }

        // First pass: correct positions
        for (let i = 0; i < WORD_LENGTH; i++) {
          if (guess[i] === solution[i]) {
            result[i] = "correct";
            letterCounts[guess[i]] -= 1;
          }
        }

        // Second pass: present letters
        for (let i = 0; i < WORD_LENGTH; i++) {
          if (result[i] === "correct") continue;
          const ch = guess[i];
          if (letterCounts[ch] > 0) {
            result[i] = "present";
            letterCounts[ch] -= 1;
          }
        }

        applyResultToRow(currentRow, guess, result);
        updateKeyboard(result, guess);

        if (guess === solution) {
          isGameOver = true;
          setStatus("You found it. The dream glows softly in the dark. 🌙");
          setMascot("victorious", `"${prettyGuess}" was waiting for you all along, and you found it skillfully!`);
          triggerFireflyWinSwarm();
          setTimeout(() => setMascot("celebrating", "The fireflies are dancing for you. You light up this little night."), 900);
          return;
        }

        if (currentRow === MAX_GUESSES - 1) {
          isGameOver = true;
          setStatus(`Out of guesses. The word was "${SECRET_WORD}".`);
          setMascot("concerned", "Even when a dream slips away, the fireflies remember how bravely you tried.");
          return;
        }

        const matchScore = result.filter(r => r === "correct" || r === "present").length;
        if (matchScore >= 3) {
          setMascot("sweet", `"${prettyGuess}" was so close— I can almost see your dream flickering into shape.`);
        } else if (matchScore >= 1) {
          setMascot("unsure", `"${prettyGuess}" has some of the right pieces. I'm right here with you for the next try.`);
        } else {
          setMascot("neutral", `We all get a little lost sometimes. I love your resolve and heart. Let's continue looking!`);
        }

        currentRow++;
        currentCol = 0;
      }

      function applyResultToRow(rowIndex, guess, result) {
        for (let i = 0; i < WORD_LENGTH; i++) {
          const tile = gridEl.querySelector(`.fireflies-tile[data-row="${rowIndex}"][data-col="${i}"]`);
          if (!tile) continue;
          tile.classList.remove("state-correct", "state-present", "state-absent");
          if (result[i] === "correct") {
            tile.classList.add("state-correct");
          } else if (result[i] === "present") {
            tile.classList.add("state-present");
          } else {
            tile.classList.add("state-absent");
          }
        }
      }

      function updateKeyboard(result, guess) {
        for (let i = 0; i < WORD_LENGTH; i++) {
          const ch = guess[i].toUpperCase();
          const keyBtn = keyboardEl.querySelector(`.fireflies-key[data-key="${ch}"]`);
          if (!keyBtn) continue;
          const state = result[i];
          if (state === "correct") {
            keyBtn.classList.remove("state-present", "state-absent");
            keyBtn.classList.add("state-correct");
          } else if (state === "present") {
            if (!keyBtn.classList.contains("state-correct")) {
              keyBtn.classList.remove("state-absent");
              keyBtn.classList.add("state-present");
            }
          } else {
            if (!keyBtn.classList.contains("state-correct") && !keyBtn.classList.contains("state-present")) {
              keyBtn.classList.add("state-absent");
            }
          }
        }
      }

      function resetGame() {
        for (let r = 0; r < MAX_GUESSES; r++) {
          for (let c = 0; c < WORD_LENGTH; c++) {
            guesses[r][c] = "";
          }
        }
        currentRow = 0;
        currentCol = 0;
        isGameOver = false;
        updateGrid();
        gridEl.querySelectorAll(".fireflies-tile").forEach(t => {
          t.classList.remove("state-correct", "state-present", "state-absent");
        });
        keyboardEl.querySelectorAll(".fireflies-key").forEach(k => {
          k.classList.remove("state-correct", "state-present", "state-absent");
        });
        setStatus("");
        setMascot("neutral", "Six chances, five letters. Let's chase a gentle little dream through the fireflies together.");
      }

      document.addEventListener("keydown", (e) => {
        if (!isActivePanel()) return;
        if (e.metaKey || e.ctrlKey || e.altKey) return;

        if (e.key === "Enter") {
          e.preventDefault();
          handleKey("ENTER");
        } else if (e.key === "Backspace") {
          e.preventDefault();
          handleKey("BACKSPACE");
        } else if (/^[a-zA-Z]$/.test(e.key)) {
          e.preventDefault();
          handleKey(e.key.toUpperCase());
        }
      });

      resetBtn.addEventListener("click", () => {
        resetGame();
      });

      const mascotEl = document.getElementById("firefliesMascot");
      if (mascotEl) {
        mascotEl.style.cursor = "pointer";
        mascotEl.addEventListener("click", () => {
          setMascot("sweet", "You're doing wonderfully. Every guess is another little lantern you light for both of us.");
        });
      }

      // Init
      buildGrid();
      buildKeyboard();
      updateGrid();
      setMascot("neutral", "Six chances, five letters. Let's chase a gentle little dream through the fireflies together.");
      setStatus("");
    })();

// --- Init ---
    createGrid();
    setupInteractions();
    updateCurrentWordDisplay();
    updateSpecialListUI();
    updateWordsUI();
    updateGoalProgressUI();
    setMascotMood("soft");
    startAmbientMusic();
  </script>
</body>
</html>
